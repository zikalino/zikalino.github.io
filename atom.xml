<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Zim's Notes]]></title>
  <link href="http://zikalino.github.io/atom.xml" rel="self"/>
  <link href="http://zikalino.github.io/"/>
  <updated>2019-05-27T11:55:25+08:00</updated>
  <id>http://zikalino.github.io/</id>
  <author>
    <name><![CDATA[Your Name]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Idea of Using Azure CLI Extension to Test, Validate, Fix and Create Azure Swagger Examples]]></title>
    <link href="http://zikalino.github.io/blog/2019/05/27/idea-of-using-azure-cli-extension-to-test-validate-fix-and-create-azure-swagger-examples/"/>
    <updated>2019-05-27T11:01:54+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/05/27/idea-of-using-azure-cli-extension-to-test-validate-fix-and-create-azure-swagger-examples</id>
    <content type="html"><![CDATA[<p>This idea occured to me for three reasons:</p>

<ul>
<li>there&rsquo;s no single tool used to create, test and validate Azure Swagger examples</li>
<li>Azure CLI is the most commonly used tool to manage Azure resources</li>
<li>it would be very easy to create an extension based on <strong>az resource</strong> which already allows raw REST API calls meaning it provides entire framework</li>
</ul>


<h2>Running / Validating Existing Examples</h2>

<h3>Overview</h3>

<p>The tool should allow to:
- run existing examples directly from Azure REST API specs (local or GitHub repo)
- run examples in their raw form
- automatically fix problems / adjust naming conventions to match common naming convention
- allow applying custom parameter fixes
- generate final adjusted / updated example source code
- optionally copy example to original source tree or create a pull request in original GitHub repo (fork of Azure REST API specification)</p>

<h3>Command</h3>

<p>To run existing example:</p>

<p><strong>az swagger run &ndash;example {location} [&ndash;raw] [&ndash;override {field}={value}] [&ndash;dependencies] [&ndash;update]</strong></p>

<p>where:</p>

<p><strong>&ndash;example</strong></p>

<p>{location} - either URL of example in GitHub or local path to example in cloned GitHub repo</p>

<p><strong>&ndash;raw</strong></p>

<p>If specified all field values from the example files will be used as is.</p>

<p>By default extension would override existing values using default resource naming conventions.</p>

<p><strong>&ndash;override</strong></p>

<p>{field} - field name or path to a field in</p>

<p><strong>&ndash;dependencies</strong></p>

<p>The tool will attempt to create all the dependencies if they don&rsquo;t exist, e.g. resource group or parent resource (using appropriate examples from swagger).</p>

<p>If this option is note specified, the tool will display appropriate warnings.</p>

<p><strong>&ndash;update</strong></p>

<p>If this option is specified extension will attempt to update existing sample in the local filesystem.
In the future it could create a branch and pull requests directly to the GitHub Repo.</p>

<p>The attempt will be made if:
- example was run successfully
- there are differences between existing example input parameters and overrided input parameters
- there is difference in return value specified and value actually returned</p>

<p>Sample input could look like that:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>az swagger run --example https://github.com/Azure/azure-rest-api-specs/blob/master/specification/botservice/resource-manager/Microsoft.BotService/preview/2018-07-12/examples/CreateBot.json</span></code></pre></td></tr></table></div></figure>


<p>Sample output could look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-------- WARNINGS
</span><span class='line'>- resourceGroupName "OneResourceGroup" was replaced by "myResourceGroup"
</span><span class='line'>- resourceName "sampleBot" was replaced by "myBot"
</span><span class='line'>-------- ORIGINAL EXAMPLE
</span><span class='line'>{
</span><span class='line'>  "parameters": {
</span><span class='line'>    "subscriptionId": "subscription-id",
</span><span class='line'>    "resourceGroupName": "OneResourceGroupName",
</span><span class='line'>    "api-version": "2017-01-01",
</span><span class='line'>    "resourceName": "samplebotname",
</span><span class='line'>    "parameters": {
</span><span class='line'>      "location": "West US",
</span><span class='line'>      "sku": {
</span><span class='line'>        "name": "S1"
</span><span class='line'>      },
</span><span class='line'>      "etag": "etag1",
</span><span class='line'>      "tags": {
</span><span class='line'>        "tag1": "value1",
</span><span class='line'>        "tag2": "value2"
</span><span class='line'>      },
</span><span class='line'>      "name": "samplename",
</span><span class='line'>      "type": "sampletype",
</span><span class='line'>      "id": "someid",
</span><span class='line'>      "kind": "sdk",
</span><span class='line'>      "properties": {
</span><span class='line'>        "description": "The description of the bot",
</span><span class='line'>        "developerAppInsightKey": "appinsightskey",
</span><span class='line'>        "developerAppInsightsApiKey": "appinsightsapikey",
</span><span class='line'>        "developerAppInsightsApplicationId": "appinsightsappid",
</span><span class='line'>        "displayName": "The Name of the bot",
</span><span class='line'>        "endpoint": "http://mybot.coffee",
</span><span class='line'>        "iconUrl": "http://myicon",
</span><span class='line'>        "luisAppIds": [
</span><span class='line'>          "luisappid1",
</span><span class='line'>          "luisappid2"
</span><span class='line'>        ],
</span><span class='line'>        "luisKey": "luiskey",
</span><span class='line'>        "msaAppId": "exampleappid"
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "responses": {
</span><span class='line'>    "200": {
</span><span class='line'>      "body": {
</span><span class='line'>        "location": "West US",
</span><span class='line'>        "tags": {
</span><span class='line'>          "tag1": "value1",
</span><span class='line'>          "tag2": "value2"
</span><span class='line'>        },
</span><span class='line'>        "name": "samplename",
</span><span class='line'>        "type": "sampletype",
</span><span class='line'>        "id": "someid",
</span><span class='line'>        "kind": "sdk",
</span><span class='line'>        "etag": "etag1",
</span><span class='line'>        "properties": {
</span><span class='line'>          "description": "The description of the bot",
</span><span class='line'>          "developerAppInsightKey": "appinsightskey",
</span><span class='line'>          "developerAppInsightsApplicationId": "appinsightsappid",
</span><span class='line'>          "displayName": "The Name of the bot",
</span><span class='line'>          "endpoint": "http://mybot.coffee",
</span><span class='line'>          "endpointVersion": "version",
</span><span class='line'>          "iconUrl": "http://myicon",
</span><span class='line'>          "luisAppIds": [
</span><span class='line'>            "luisappid1",
</span><span class='line'>            "luisappid2"
</span><span class='line'>          ],
</span><span class='line'>          "msaAppId": "msaappid",
</span><span class='line'>          "configuredChannels": [
</span><span class='line'>            "facebook",
</span><span class='line'>            "groupme"
</span><span class='line'>          ],
</span><span class='line'>          "enabledChannels": [
</span><span class='line'>            "facebook"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    },
</span><span class='line'>    "201": {
</span><span class='line'>      "body": {
</span><span class='line'>        "location": "West US",
</span><span class='line'>        "tags": {
</span><span class='line'>          "tag1": "value1",
</span><span class='line'>          "tag2": "value2"
</span><span class='line'>        },
</span><span class='line'>        "name": "samplename",
</span><span class='line'>        "type": "sampletype",
</span><span class='line'>        "id": "someid",
</span><span class='line'>        "kind": "sdk",
</span><span class='line'>        "properties": {
</span><span class='line'>          "description": "The description of the bot",
</span><span class='line'>          "developerAppInsightsApplicationId": "appinsightsappid",
</span><span class='line'>          "displayName": "The Name of the bot",
</span><span class='line'>          "endpoint": "http://mybot.coffee",
</span><span class='line'>          "endpointVersion": "version",
</span><span class='line'>          "iconUrl": "http://myicon",
</span><span class='line'>          "luisAppIds": [
</span><span class='line'>            "luisappid1",
</span><span class='line'>            "luisappid2"
</span><span class='line'>          ],
</span><span class='line'>          "msaAppId": "msaappid",
</span><span class='line'>          "configuredChannels": [
</span><span class='line'>            "facebook",
</span><span class='line'>            "groupme"
</span><span class='line'>          ],
</span><span class='line'>          "enabledChannels": [
</span><span class='line'>            "facebook"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>-------- UPDATED EXAMPLE (createbot.json)
</span><span class='line'>{
</span><span class='line'>  "parameters": {
</span><span class='line'>    "subscriptionId": "subscription-id",
</span><span class='line'>    "resourceGroupName": "myResourceGroup",
</span><span class='line'>    "api-version": "2017-01-01",
</span><span class='line'>    "resourceName": "myBot",
</span><span class='line'>    "parameters": {
</span><span class='line'>      "location": "West US",
</span><span class='line'>      "sku": {
</span><span class='line'>        "name": "S1"
</span><span class='line'>      },
</span><span class='line'>      "etag": "etag1",
</span><span class='line'>      "tags": {
</span><span class='line'>        "tag1": "value1",
</span><span class='line'>        "tag2": "value2"
</span><span class='line'>      },
</span><span class='line'>      "name": "samplename",
</span><span class='line'>      "type": "sampletype",
</span><span class='line'>      "id": "someid",
</span><span class='line'>      "kind": "sdk",
</span><span class='line'>      "properties": {
</span><span class='line'>        "description": "The description of the bot",
</span><span class='line'>        "developerAppInsightKey": "appinsightskey",
</span><span class='line'>        "developerAppInsightsApiKey": "appinsightsapikey",
</span><span class='line'>        "developerAppInsightsApplicationId": "appinsightsappid",
</span><span class='line'>        "displayName": "The Name of the bot",
</span><span class='line'>        "endpoint": "http://mybot.coffee",
</span><span class='line'>        "iconUrl": "http://myicon",
</span><span class='line'>        "luisAppIds": [
</span><span class='line'>          "luisappid1",
</span><span class='line'>          "luisappid2"
</span><span class='line'>        ],
</span><span class='line'>        "luisKey": "luiskey",
</span><span class='line'>        "msaAppId": "exampleappid"
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "responses": {
</span><span class='line'>    "200": {
</span><span class='line'>      "body": {
</span><span class='line'>        "location": "West US",
</span><span class='line'>        "tags": {
</span><span class='line'>          "tag1": "value1",
</span><span class='line'>          "tag2": "value2"
</span><span class='line'>        },
</span><span class='line'>        "name": "samplename",
</span><span class='line'>        "type": "sampletype",
</span><span class='line'>        "id": "someid",
</span><span class='line'>        "kind": "sdk",
</span><span class='line'>        "etag": "etag1",
</span><span class='line'>        "properties": {
</span><span class='line'>          "description": "The description of the bot",
</span><span class='line'>          "developerAppInsightKey": "appinsightskey",
</span><span class='line'>          "developerAppInsightsApplicationId": "appinsightsappid",
</span><span class='line'>          "displayName": "The Name of the bot",
</span><span class='line'>          "endpoint": "http://mybot.coffee",
</span><span class='line'>          "endpointVersion": "version",
</span><span class='line'>          "iconUrl": "http://myicon",
</span><span class='line'>          "luisAppIds": [
</span><span class='line'>            "luisappid1",
</span><span class='line'>            "luisappid2"
</span><span class='line'>          ],
</span><span class='line'>          "msaAppId": "msaappid",
</span><span class='line'>          "configuredChannels": [
</span><span class='line'>            "facebook",
</span><span class='line'>            "groupme"
</span><span class='line'>          ],
</span><span class='line'>          "enabledChannels": [
</span><span class='line'>            "facebook"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    },
</span><span class='line'>    "201": {
</span><span class='line'>      "body": {
</span><span class='line'>        "location": "West US",
</span><span class='line'>        "tags": {
</span><span class='line'>          "tag1": "value1",
</span><span class='line'>          "tag2": "value2"
</span><span class='line'>        },
</span><span class='line'>        "name": "samplename",
</span><span class='line'>        "type": "sampletype",
</span><span class='line'>        "id": "someid",
</span><span class='line'>        "kind": "sdk",
</span><span class='line'>        "properties": {
</span><span class='line'>          "description": "The description of the bot",
</span><span class='line'>          "developerAppInsightsApplicationId": "appinsightsappid",
</span><span class='line'>          "displayName": "The Name of the bot",
</span><span class='line'>          "endpoint": "http://mybot.coffee",
</span><span class='line'>          "endpointVersion": "version",
</span><span class='line'>          "iconUrl": "http://myicon",
</span><span class='line'>          "luisAppIds": [
</span><span class='line'>            "luisappid1",
</span><span class='line'>            "luisappid2"
</span><span class='line'>          ],
</span><span class='line'>          "msaAppId": "msaappid",
</span><span class='line'>          "configuredChannels": [
</span><span class='line'>            "facebook",
</span><span class='line'>            "groupme"
</span><span class='line'>          ],
</span><span class='line'>          "enabledChannels": [
</span><span class='line'>            "facebook"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>-------- RESULT
</span><span class='line'>UPDATED: YES
</span><span class='line'>RUN: SUCCESS</span></code></pre></td></tr></table></div></figure>


<h2>Scaffolding Examples</h2>

<h3>Overview</h3>

<p>If example doesn&rsquo;t exist, the tool will allow creating a template based on REST API specs.
In the next step user should update the template and rerun the tool to validate example until it runs correctly.</p>

<h3>Command</h3>

<p><strong>az swagger scaffold &ndash;swagger {location} &ndash;uri {resource-uri} &ndash;method {method} [&ndash;update]</strong></p>

<p><strong>&ndash;example</strong></p>

<p>{location} - either URL of specific swagger json file or path in local</p>

<p><strong>&ndash;uri</strong></p>

<p>Resource URI as appears in swagger specification / documentation.</p>

<p><strong>&ndash;method</strong></p>

<p>Method for which scaffolding should be done, e.g. <strong>put</strong>, <strong>get</strong>, etc&hellip;</p>

<p><strong>&ndash;update</strong></p>

<p>If this option is specified extension will attempt to update existing sample in the local filesystem.
In the future it could create a branch and pull requests directly to the GitHub Repo.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ansible and Azure CLI]]></title>
    <link href="http://zikalino.github.io/blog/2019/05/22/ansible-and-azure-cli/"/>
    <updated>2019-05-22T11:25:08+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/05/22/ansible-and-azure-cli</id>
    <content type="html"><![CDATA[<h3>What if&hellip;</h3>

<p>&hellip; Ansible support for Azure was based on <strong>Azure CLI</strong>?</p>

<p>We could have a single base <strong>az</strong> Ansible module to encapsulate <strong>Azure CLI</strong>.</p>

<p>This module would just handle all the interaction with unerlying <strong>Azure CLI</strong>, including:
- handling currently selected subscription if necessary
- handling authentication</p>

<p>On the top of that we could just create symbolic links to that module for every Azure resource, for instance:</p>

<ul>
<li><strong>az_vm</strong></li>
<li><strong>az_acr</strong></li>
<li><strong>az_vmss</strong></li>
</ul>


<p><strong>az</strong> module knows through which link it was called, so it could generate documentation and argument specification dynamically.</p>

<h3>Benefits</h3>

<ul>
<li>Azure CLI has extremely well maintained UX, which just appears ideal for tools like Ansible</li>
<li>Examples are curated for every resource and well tested</li>
<li>Documentation could be just reused without any changes</li>
</ul>


<h3>What&rsquo;s missing?</h3>

<ul>
<li>idempotence</li>
<li>idempotence</li>
<li>idempotence</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Processing Azure REST Examples]]></title>
    <link href="http://zikalino.github.io/blog/2019/05/14/processing-azure-rest-examples/"/>
    <updated>2019-05-14T11:26:13-07:00</updated>
    <id>http://zikalino.github.io/blog/2019/05/14/processing-azure-rest-examples</id>
    <content type="html"><![CDATA[<h2>Some Issues with Azure REST API Examples</h2>

<ul>
<li>Examples are currently not tested</li>
<li>No naming conventions</li>
<li>Missing Examples (for instance Web App, Function App, I have created missing Resource Group example myself)</li>
<li>No dependencies</li>
</ul>


<h2>Solutions</h2>

<h3>Example naming conventions</h3>

<p>I am using resource URIs to create sample names. For instance:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>network_virtualnetworks_subnets_put.yml
</span><span class='line'>network_virtualnetworks_put.yml
</span><span class='line'>resourcegroups_put.yml</span></code></pre></td></tr></table></div></figure>


<p>This approach makes it easy to find dependencies between examples, which is shown in the demo below.</p>

<h3>Resource naming conventions within samples</h3>

<p>I am overriding names of the resources with names derived from URI pattern.</p>

<p>For instance resource group will be always called <strong>myresourcegroup</strong>, and this makes combining examples trivial.</p>

<h3>Extend Example Validation</h3>

<p>More checks can be introduced to validate examples against actual REST API definition to detect mistakes. I will include more examples here.</p>

<h3>Encourage Reusing REST API Examples Downstream</h3>

<p>Currently examples from REST API are not used directly in any other project. Encouraging usage, testing and contributing fixes upstream would significantly improve REST API specs for everyone.</p>

<h2>What we do in Ansible?</h2>

<p>We are currently developing Autorest / Magic Modules solution to generate Ansible and Terraform modules.</p>

<p>Ansible modules should come with appropriate examples, and also having integration tests are requirement.</p>

<p>Before:</p>

<ul>
<li>examples were usually written manually</li>
<li>examples were sometimes broken or getting outdated</li>
<li>integration tests were written manually</li>
</ul>


<p>Where we are going to do now:</p>

<ul>
<li>we want to have requirement that examples included in the module are <strong>all</strong> included/kept in sync with integration test</li>
<li>examples and integration tests are <strong>not</strong> written manually</li>
</ul>


<p>Benefits:</p>

<ul>
<li>Azure REST API Examples are tested</li>
<li>Examples are fixed/added at the source which is beneficial to everyone</li>
<li>Ensuring that Azure REST API documentation has actually complete/correct examples</li>
<li>Ansible/Terraform documentation has complete and correct examples that are inline with generic Azure documentation</li>
</ul>


<h2>What could be done next?</h2>

<ul>
<li>integrate autorest.devops autorest extension with Azure REST API Specs CI</li>
<li>enforce new rules / possibly generate warnings when necessary?</li>
<li>calculate API score for every resource including example coverage, following naming conventions, etc.</li>
</ul>


<h2>Sample Processed Output</h2>

<h3>Subnet Example</h3>

<p>Below you can see <strong>network_virtualnetworks_subnet_put.yml</strong> example.</p>

<p>On the top you can see that it automatically includes <strong>network_virtualnetworks_put.yml</strong> example that creates virtual network.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- import_playbook: network_virtualnetworks_put.yml
</span><span class='line'>- hosts: localhost
</span><span class='line'>  roles:
</span><span class='line'>    - ../modules
</span><span class='line'>  vars_files:
</span><span class='line'>    - _vars.yml
</span><span class='line'>  vars:
</span><span class='line'>    resource_group: myresourcegroup
</span><span class='line'>    virtual_network_name: myvirtualnetwork
</span><span class='line'>    subnet_name: mysubnet
</span><span class='line'>  tasks:
</span><span class='line'>    - name: Create subnet
</span><span class='line'>      azure_rm_resource:
</span><span class='line'>        idempotency: yes
</span><span class='line'>        api_version: '2018-02-01'
</span><span class='line'>        polling_timeout: 600
</span><span class='line'>        polling_interval: 30
</span><span class='line'>        # url: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/virtualNetworks/{virtualNetworkName}/subnets/{subnetName}
</span><span class='line'>        resource_group: '{{ resource_group }}'
</span><span class='line'>        provider: Network
</span><span class='line'>        resource_type: virtualNetworks
</span><span class='line'>        resource_name: "{{ virtual_network_name }}"
</span><span class='line'>        subresource:
</span><span class='line'>          - type: subnets
</span><span class='line'>            name: "{{ subnet_name }}"
</span><span class='line'>        body:
</span><span class='line'>          properties:
</span><span class='line'>            addressPrefix: "10.0.0.0/16"</span></code></pre></td></tr></table></div></figure>


<h3>Virtual Network Example</h3>

<p>Below you can see <strong>network_virtualnetwork_put.yml</strong> example that was referred in previous playbook.</p>

<p>On the top you can see that it automatically includes <strong>resourcegroups_put.yml</strong> example that creates required .</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- import_playbook: resourcegroups_put.yml
</span><span class='line'>- hosts: localhost
</span><span class='line'>  roles:
</span><span class='line'>    - ../modules
</span><span class='line'>  vars_files:
</span><span class='line'>    - _vars.yml
</span><span class='line'>  vars:
</span><span class='line'>    resource_group: myresourcegroup
</span><span class='line'>    virtual_network_name: myvirtualnetwork
</span><span class='line'>  tasks:
</span><span class='line'>    - name: Create virtual network
</span><span class='line'>      azure_rm_resource:
</span><span class='line'>        idempotency: yes
</span><span class='line'>        api_version: '2018-02-01'
</span><span class='line'>        polling_timeout: 600
</span><span class='line'>        polling_interval: 30
</span><span class='line'>        # url: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/virtualNetworks/{virtualNetworkName}
</span><span class='line'>        resource_group: '{{ resource_group }}'
</span><span class='line'>        provider: Network
</span><span class='line'>        resource_type: virtualNetworks
</span><span class='line'>        resource_name: "{{ virtual_network_name }}"
</span><span class='line'>        body:
</span><span class='line'>          properties:
</span><span class='line'>            addressSpace:
</span><span class='line'>              addressPrefixes:
</span><span class='line'>                - "10.0.0.0/16"
</span><span class='line'>          location: "eastus"</span></code></pre></td></tr></table></div></figure>


<h3>Resource Group Example</h3>

<p>And finally you can check <strong>resource_groups_put.yml</strong> example that is required by previous playbooks.</p>

<p>On the top you can see that it automatically includes <strong>resourcegroups_put.yml</strong> example that creates required.</p>

<p>You can find a PR here that I have merged to REST API specs:</p>

<p><a href="https://github.com/Azure/azure-rest-api-specs/pull/4971">https://github.com/Azure/azure-rest-api-specs/pull/4971</a></p>

<p>You can find the same example was propagated here to Azure REST API docs:</p>

<p><a href="https://docs.microsoft.com/en-us/rest/api/resources/resourcegroups/createorupdate">https://docs.microsoft.com/en-us/rest/api/resources/resourcegroups/createorupdate</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- hosts: localhost
</span><span class='line'>  roles:
</span><span class='line'>    - ../modules
</span><span class='line'>  vars_files:
</span><span class='line'>    - _vars.yml
</span><span class='line'>  vars:
</span><span class='line'>    resource_group: myresourcegroup
</span><span class='line'>  tasks:
</span><span class='line'>    - name: Create or update a resource group.
</span><span class='line'>      azure_rm_resource:
</span><span class='line'>        idempotency: yes
</span><span class='line'>        api_version: '2018-05-01'
</span><span class='line'>        # url: /subscriptions/{subscriptionId}/resourcegroups/{resourceGroupName}
</span><span class='line'>        resource_group: '{{ resource_group }}'
</span><span class='line'>        body:
</span><span class='line'>          location: eastus</span></code></pre></td></tr></table></div></figure>


<h2>Demo</h2>

<h3>Prerequisites</h3>

<p>Ansible 2.8</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pip install ansible[azure]</span></code></pre></td></tr></table></div></figure>


<p>Clone sample repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/zikalino/ansible-azure-rest-examples.git
</span><span class='line'>cd examples</span></code></pre></td></tr></table></div></figure>


<h3>Running Examples Demo</h3>

<p>From examples folder run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ansible-playbook network_virtual_networks_subnet_put.yml</span></code></pre></td></tr></table></div></figure>


<p>You should see that all dependencies and subnet are correctly created:</p>

<p><img src="http://zikalino.github.io/images/running-examples.png" alt="Running Examples Demo" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Creating Azure Function App Using REST API]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/27/creating-azure-function-app-using-rest-api/"/>
    <updated>2019-03-27T13:47:38+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/27/creating-azure-function-app-using-rest-api</id>
    <content type="html"><![CDATA[<p>Finally I got it working&hellip;</p>

<p>I used appservice plan as created in my previous post:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>az appservice plan create --name myplan -g zimsfromclixx --is-linux --location westeurope --sku S1 --number-of-workers 1
</span></code></pre></td></tr></table></div></figure>


<p>and updated my task to refer that Linux-enabled plan (<strong>serverFarmId</strong>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>- name: Create Function App using REST API
</span><span class='line'>  azure_rm_resource:
</span><span class='line'>    api_version: <span class="s1">&#39;2018-02-01&#39;</span>
</span><span class='line'>    resource_group: <span class="s2">&quot;&quot;</span>
</span><span class='line'>    provider: web
</span><span class='line'>    resource_type: sites
</span><span class='line'>    resource_name: <span class="s2">&quot;&quot;</span>
</span><span class='line'>    body:
</span><span class='line'>      kind: functionapp,linux,container
</span><span class='line'>      properties:
</span><span class='line'>        siteConfig:
</span><span class='line'>          appSettings:
</span><span class='line'>            - name: FUNCTIONS_EXTENSION_VERSION
</span><span class='line'>              value<span class="s1">&#39;: &#39;</span>~2<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">            - name: DOCKER_REGISTRY_SERVER_URL</span>
</span><span class='line'><span class="s1">              value: &#39;</span>https://index.docker.io<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">          linuxFxVersion: &#39;</span>DOCKER<span class="p">|</span>httpd<span class="err">&#39;</span>
</span><span class='line'>        serverFarmId: /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsfromclixx/providers/Microsoft.Web/serverFarms/myplan
</span><span class='line'>      location: eastus
</span></code></pre></td></tr></table></div></figure>


<p>Task is pretty simple, and I guess it may be simplified even further. I plan to create full sample, and add apropriate updates to <strong>azure_rm_functionapp</strong> module.
Plus I will create a new sample for Azure REST API specification. That was at least two days of work to get here&hellip;.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Creating Container Based Function App Using Azure CLI]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/27/creating-container-based-function-app-using-azure-cli/"/>
    <updated>2019-03-27T12:53:55+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/27/creating-container-based-function-app-using-azure-cli</id>
    <content type="html"><![CDATA[<p>It&rsquo;s just a few lines of code, but took me some time to do it by trial and error.</p>

<p>Just a few steps:</p>

<p>(1) create resource group</p>

<p>(2) create storage account</p>

<p>(3) create appservice plan with <strong>is_linux</strong> option</p>

<p>(4) create function app and specify container image <strong>httpd</strong> from DockerHub</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>az group create --name zimsfromclixx --location westeurope
</span><span class='line'>
</span><span class='line'>az storage account create --name zimsstoragefromclixx --location westeurope --resource-group zimsfromclixx --sku Standard_LRS
</span><span class='line'>
</span><span class='line'>az appservice plan create --name myplan -g zimsfromclixx --is-linux --location westeurope --sku S1 --number-of-workers 1
</span><span class='line'>
</span><span class='line'>az functionapp create --resource-group zimsfromclixx --os-type Linux --plan myplan --name zimsfromclixx --deployment-container-image-name httpd --storage-account zimsstoragefromclixx
</span></code></pre></td></tr></table></div></figure>


<p>Just run the commands using Azure CLI, go to the browser and enter <a href="https://zimsfromclixx.azurewebsites.net/">https://zimsfromclixx.azurewebsites.net/</a> (you may use your own functionapp name here), and you should see standard Apache&rsquo;s **It Works!!&ldquo; welcome page.</p>

<p>Sounds easy, however when creating functionapp, <strong>&ndash;plan</strong> argument is not obligatory, and if you omit step (3) and <strong>&ndash;plan</strong> argument, default plan will be created, and with default plan you can&rsquo;t use containers. It took me some time to figure out&hellip;.</p>

<p>Also some people run into similar problem, for instance here:</p>

<p><a href="https://github.com/Azure/azure-cli/issues/7426">https://github.com/Azure/azure-cli/issues/7426</a></p>

<p>In fact only this PR helped me to understand how Azure CLI works:</p>

<p><a href="https://github.com/Azure/azure-cli/pull/7435/files">https://github.com/Azure/azure-cli/pull/7435/files</a></p>

<p>When you try to specify <strong>&ndash;deployment-container-image-name httpd</strong> without passing <strong>&ndash;plan</strong> that is <strong>is_linux</strong>, Azure CLI resoponds with following message, which is quite misleading:</p>

<p><strong>usage error: &ndash;runtime RUNTIME required for linux functions apps without custom image.</strong></p>

<p>I submitted issue to Azure CLI regarding this: <a href="https://github.com/Azure/azure-cli/issues/8889">https://github.com/Azure/azure-cli/issues/8889</a></p>

<p>Finally, here&rsquo;s a link to some documentation I found later:</p>

<p><a href="https://docs.microsoft.com/en-us/azure/app-service/containers/app-service-linux-cli">https://docs.microsoft.com/en-us/azure/app-service/containers/app-service-linux-cli</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Coming Rename of _facts Modules to _info Modules]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/25/coming-rename-of-facts-modules-to-info-modules/"/>
    <updated>2019-03-25T13:24:19+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/25/coming-rename-of-facts-modules-to-info-modules</id>
    <content type="html"><![CDATA[<p>It requires some statistics on what needs to be done:</p>

<table>
<thead>
<tr>
<th>Module Name</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>azure_rm_aks_facts</td>
<td>2.6</td>
<td>** needs upgrade</td>
</tr>
<tr>
<td>azure_rm_applicationsecuritygroup_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_appserviceplan_facts</td>
<td>2.7</td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_autoscale_facts</td>
<td>2.7</td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_availabilityset_facts</td>
<td>OLD</td>
<td>** needs upgrade</td>
</tr>
<tr>
<td>azure_rm_cdnendpoint_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_cdnprofile_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_containerinstance_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_containerregistry_facts</td>
<td>2.7</td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_cosmosdbaccount_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_deployment_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_devtestlabarmtemplate_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_devtestlabartifactsource_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_devtestlabartifact_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_devtestlabcustomimage_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_devtestlabenvironment_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_devtestlabartifact_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_devtestlabpolicy_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_devtestlabvirtualmachine_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_devtestlabvirtualnetwork_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_devtestlab_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_dnsrecordset_facts</td>
<td>OLD/SPLIT</td>
<td>split/obsolete</td>
</tr>
<tr>
<td>azure_rm_dnszone_facts</td>
<td>OLD/SPLIT</td>
<td>split/obsolete</td>
</tr>
<tr>
<td>azure_rm_functionapp_facts</td>
<td>OLD</td>
<td>** needs upgrade</td>
</tr>
<tr>
<td>azure_rm_hdinsight_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_image_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_loadbalancer_facts</td>
<td>OLD</td>
<td>** needs upgrade</td>
</tr>
<tr>
<td>azure_rm_managed_disk_facts</td>
<td>OLD</td>
<td>** needs upgrade</td>
</tr>
<tr>
<td>azure_rm_mariadbconfiguration_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_mariadbdatabase_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_mariadbfirewallrule_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_mariadbserver_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_mysqlconfiguration_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_mysqldatabase_facts</td>
<td></td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_mysqlfirewallrule_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_mysqlserver_facts</td>
<td></td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_networkinterface_facts</td>
<td>OLD/SPLIT</td>
<td>split/obsolete</td>
</tr>
<tr>
<td>azure_rm_postgresqlconfiguration_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_postgresqldatabase_facts</td>
<td></td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_postgresqlfirewallrule_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_postgresqlserver_facts</td>
<td></td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_publicipaddress_facts</td>
<td>OLD/SPLIT</td>
<td>split/obsolete</td>
</tr>
<tr>
<td>azure_rm_rediscache_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_resourcegroup_facts</td>
<td>OLD</td>
<td>** needs upgrade</td>
</tr>
<tr>
<td>azure_rm_resource_facts</td>
<td>2.6</td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_roleassignment_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_roledefinition_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_routetable_facts</td>
<td>2.7</td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_securitygroup_facts</td>
<td>OLD</td>
<td>** needs upgrade</td>
</tr>
<tr>
<td>azure_rm_sqldatabase_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_sqlfirewallrule_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_sqlserver_facts</td>
<td></td>
<td>** needs upgrade</td>
</tr>
<tr>
<td>azure_rm_subnet_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_storageaccount_facts</td>
<td>OLD/SPLIT?</td>
<td>split/obsolete</td>
</tr>
<tr>
<td>azure_rm_trafficmanagerendpoint_facts</td>
<td></td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_trafficmanagerprofile_facts</td>
<td></td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_virtualmachineextension_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_virtualmachineimage_facts</td>
<td>OLD</td>
<td>** needs upgrade</td>
</tr>
<tr>
<td>azure_rm_virtualmachinescalesetextension_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_virtualmachinescalesetinstance_facts</td>
<td>2.8</td>
<td>rename</td>
</tr>
<tr>
<td>azure_rm_virtualmachine_facts</td>
<td>2.7</td>
<td>rename/obsolete</td>
</tr>
<tr>
<td>azure_rm_virtualmachine_scaleset_facts</td>
<td>OLD/SPLIT</td>
<td>split/obsolete</td>
</tr>
<tr>
<td>azure_rm_virtualnetwork_facts</td>
<td>OLD/SPLIT</td>
<td>split/obsolete</td>
</tr>
<tr>
<td>azure_rm_webapp_facts</td>
<td>2.7</td>
<td>rename/obsolete</td>
</tr>
</tbody>
</table>


<p>From above:</p>

<p><strong>needs upgrade</strong> - these modules need new <em>curated</em> version (9 modules)</p>

<p><strong>split/obsolete</strong> - these modules alerady have <em>curated</em> format, need to be split (7 modules)</p>

<p><strong>rename/obsolete</strong> - these modules were introduced before 2.8 and we need to rename them and made old version available via symbolic link and obsolete (14 modules)</p>

<p><strong>rename</strong> - these modules we introduced in Ansible 2.8, meaning they are not release them, meaning we can release them before freeze (around 35 modules)</p>

<h2>Impact on Sample Playbooks</h2>

<ul>
<li>we need to rename <strong>facts</strong> to <strong>info</strong> in all playbooks referring to new 2.8 facts modules</li>
<li>we have more then 1 year timeframe for older <strong>facts</strong> modules as they will be marked as obsolete</li>
</ul>


<h2>Impact on users</h2>

<ul>
<li>for all the new 2.8 modules they will see only new <strong>info</strong> modules, so there&rsquo;s no impact</li>
<li>for older <strong>facts</strong> modules they can use either <strong>facts</strong> or <strong>info</strong>, if they use <strong>facts</strong> they will be encouraged to switch to new <strong>info</strong> modules, also impact is minimal</li>
<li>they will have a year to change</li>
</ul>


<h2>Impact on test</h2>

<ul>
<li>same tests executed on new <strong>info</strong> modules as old <em>*facts</em> modules</li>
<li>in most cases <strong>facts</strong> modules will be symbolic links to <strong>info</strong> modules, so content will be the same</li>
<li>for oldest modules, we can disable tests for old <strong>fact</strong> or we can test both <strong>facts</strong> and <strong>info</strong></li>
</ul>


<h2>Impact on azure_preview_modules</h2>

<ul>
<li>no impact, we will just copy all the updated from devel, as usual</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dumping All the Resources in Resource Group Using Ansible]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/22/dumping-all-the-resources-in-resource-group-using-ansible/"/>
    <updated>2019-03-22T15:25:37+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/22/dumping-all-the-resources-in-resource-group-using-ansible</id>
    <content type="html"><![CDATA[<p>Now, this is pretty cool. With a very small Ansible playbook you can dump entire content of a Resource Group.</p>

<p>Please note it requires Ansible 2.8.</p>

<h2>Running the Example</h2>

<p>The example is now available in official <strong>Azure-Samples</strong>:</p>

<pre><code>https://github.com/Azure-Samples/ansible-playbooks/blob/master/rest/resourcegroup_dump_resources.yml
</code></pre>

<h2>The Playbook</h2>

<p>The playbook uses <strong>azure_rm_resource_facts</strong> module and does following steps:</p>

<ul>
<li>retrieve list of all of the resources in the resource group</li>
<li>dump list of resources</li>
<li>create list of resource ids</li>
<li>dump list of resource ids</li>
<li>iterate through resource ids and retrieve details of each resource</li>
<li>convert output to single list of all resources</li>
<li>dump detailed list of resources</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">List all the resources under a resource group</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_resource_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zimsdtl</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">resources</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Dump raw list of resouces in the resource group</span>
</span><span class='line'>  <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create a list of resource IDs</span>
</span><span class='line'>  <span class="l-Scalar-Plain">set_fact</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_ids</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">output.response</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">map(attribute=&#39;id&#39;)</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Dump list of resource IDs</span>
</span><span class='line'>  <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">resource_ids</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Iterate through the resources and query details on each one</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_resource_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>  <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_ids</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create single list of resources</span>
</span><span class='line'>  <span class="l-Scalar-Plain">set_fact</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">output.results</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">map(attribute=&#39;response&#39;)</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">sum(start=[])</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Dump final list of resources</span>
</span><span class='line'>  <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">resources</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Final Output</h2>

<p>And final output looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">PLAY [List all resources in resource group] *********************************************************************************************************************************************</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [Gathering Facts] ******************************************************************************************************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [List all the resources under a resource group] ************************************************************************************************************************************</span>
</span><span class='line'> <span class="l-Scalar-Plain">[WARNING]</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Azure API profile latest does not define an entry for GenericRestClient</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [Dump raw list of resouces in the resource group] **********************************************************************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&quot;output&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>        <span class="s">&quot;changed&quot;</span><span class="p-Indicator">:</span> <span class="nv">false</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;failed&quot;</span><span class="p-Indicator">:</span> <span class="nv">false</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;response&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span>
</span><span class='line'>            <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.DevTestLab/labs/labxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;location&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;labxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.DevTestLab/labs&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.DevTestLab/labs/labxxxx/virtualMachines/vmxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;location&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;labxxxx/vmxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.DevTestLab/labs/virtualMachines&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.KeyVault/vaults/labxxxx9607&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;location&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;labxxxx9607&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;tags&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;CreatedBy&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;DevTestLabs&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;hidden-DevTestLabs-LabUId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;1f33aff8-4e19-43e2-b2fc-181ce85afd2a&quot;</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.KeyVault/vaults&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Network/virtualNetworks/vnxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;location&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;vnxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;tags&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;hidden-DevTestLabs-LabUId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;1f33aff8-4e19-43e2-b2fc-181ce85afd2a&quot;</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.Network/virtualNetworks&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Storage/storageAccounts/alabxxxx2409&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;kind&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;StorageV2&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;location&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;alabxxxx2409&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;sku&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Standard_LRS&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;tier&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Standard&quot;</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;tags&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;hidden-DevTestLabs-LabUId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;1f33aff8-4e19-43e2-b2fc-181ce85afd2a&quot;</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.Storage/storageAccounts&quot;</span>
</span><span class='line'>            <span class="p-Indicator">}</span>
</span><span class='line'>        <span class="p-Indicator">],</span>
</span><span class='line'>        <span class="s">&quot;url&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/resources&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;warnings&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span>
</span><span class='line'>            <span class="s">&quot;Azure</span><span class="nv"> </span><span class="s">API</span><span class="nv"> </span><span class="s">profile</span><span class="nv"> </span><span class="s">latest</span><span class="nv"> </span><span class="s">does</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">define</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">entry</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">GenericRestClient&quot;</span>
</span><span class='line'>        <span class="p-Indicator">]</span>
</span><span class='line'>    <span class="p-Indicator">}</span>
</span><span class='line'><span class="err">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [Create a list of resource IDs] ****************************************************************************************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [Dump list of resource IDs] ********************************************************************************************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&quot;resource_ids&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span>
</span><span class='line'>        <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.DevTestLab/labs/labxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.DevTestLab/labs/labxxxx/virtualMachines/vmxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.KeyVault/vaults/labxxxx9607&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Network/virtualNetworks/vnxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>        <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Storage/storageAccounts/alabxxxx2409&quot;</span>
</span><span class='line'>    <span class="p-Indicator">]</span>
</span><span class='line'><span class="err">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [Iterate through the resources and query details on each one] **********************************************************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; (item=/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.DevTestLab/labs/labxxxx)</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; (item=/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.DevTestLab/labs/labxxxx/virtualMachines/vmxxxx)</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; (item=/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.KeyVault/vaults/labxxxx9607)</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; (item=/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Network/virtualNetworks/vnxxxx)</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; (item=/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Storage/storageAccounts/alabxxxx2409)</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [Create single list of resources] **************************************************************************************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [Dump final list of resources] *****************************************************************************************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&quot;resources&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span>
</span><span class='line'>        <span class="p-Indicator">{</span>
</span><span class='line'>            <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourcegroups/zimsdtl/providers/microsoft.devtestlab/labs/labxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;location&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;labxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;properties&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;announcement&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;enabled&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;expired&quot;</span><span class="p-Indicator">:</span> <span class="nv">false</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;markdown&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;title&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;artifactsStorageAccount&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Storage/storageAccounts/alabxxxx2409&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;createdDate&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;2019-03-01T08:42:35.4625319+00:00&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;defaultPremiumStorageAccount&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Storage/storageAccounts/alabxxxx2409&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;defaultStorageAccount&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Storage/storageAccounts/alabxxxx2409&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;environmentPermission&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Reader&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;labStorageType&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Standard&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;mandatoryArtifactsResourceIdsLinux&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[],</span>
</span><span class='line'>                <span class="s">&quot;mandatoryArtifactsResourceIdsWindows&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[],</span>
</span><span class='line'>                <span class="s">&quot;premiumDataDiskStorageAccount&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Storage/storageAccounts/alabxxxx2409&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;premiumDataDisks&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;provisioningState&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Succeeded&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;support&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;enabled&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;markdown&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;uniqueIdentifier&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;1f33aff8-4e19-43e2-b2fc-181ce85afd2a&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;vaultName&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.KeyVault/vaults/labxxxx9607&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.DevTestLab/labs&quot;</span>
</span><span class='line'>        <span class="p-Indicator">},</span>
</span><span class='line'>        <span class="p-Indicator">{</span>
</span><span class='line'>            <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourcegroups/zimsdtl/providers/microsoft.devtestlab/labs/labxxxx/virtualmachines/vmxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;location&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;vmxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;properties&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;allowClaim&quot;</span><span class="p-Indicator">:</span> <span class="nv">false</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;artifactDeploymentStatus&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;artifactsApplied&quot;</span><span class="p-Indicator">:</span> <span class="nv">0</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;totalArtifacts&quot;</span><span class="p-Indicator">:</span> <span class="nv">0</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;computeId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/labxxxx-vmxxxx-561112/providers/Microsoft.Compute/virtualMachines/vmxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;createdByUser&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;createdByUserId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;createdDate&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;2019-03-01T08:44:56.9375632+00:00&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;dataDiskParameters&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[],</span>
</span><span class='line'>                <span class="s">&quot;disallowPublicIpAddress&quot;</span><span class="p-Indicator">:</span> <span class="nv">false</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;expirationDate&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;2029-02-22T01:49:12.117974+00:00&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;fqdn&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;vmxxxx.eastus.cloudapp.azure.com&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;galleryImageReference&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;offer&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;UbuntuServer&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;osType&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Linux&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;publisher&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Canonical&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;sku&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;16.04-LTS&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;version&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;latest&quot;</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;labSubnetName&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;vnxxxxSubnet&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;labVirtualNetworkId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.DevTestLab/labs/labxxxx/virtualnetworks/vnxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;lastKnownPowerState&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Stopped&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;networkInterface&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{},</span>
</span><span class='line'>                <span class="s">&quot;notes&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Virtual</span><span class="nv"> </span><span class="s">machine</span><span class="nv"> </span><span class="s">notes,</span><span class="nv"> </span><span class="s">just</span><span class="nv"> </span><span class="s">something....&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;osType&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Linux&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;ownerObjectId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;20d81029-94cd-4923-a766-994415ff73bd&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;ownerUserPrincipalName&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;provisioningState&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Succeeded&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;size&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Standard_A2_v2&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;storageType&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Standard&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;uniqueIdentifier&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;39fc5a87-2b95-48ff-a827-468902b78149&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;userName&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;dtladmin&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;virtualMachineCreationSource&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;FromGalleryImage&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.DevTestLab/labs/virtualMachines&quot;</span>
</span><span class='line'>        <span class="p-Indicator">},</span>
</span><span class='line'>        <span class="p-Indicator">{</span>
</span><span class='line'>            <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.KeyVault/vaults/labxxxx9607&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;location&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;labxxxx9607&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;properties&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;accessPolicies&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span>
</span><span class='line'>                    <span class="p-Indicator">{</span>
</span><span class='line'>                        <span class="s">&quot;objectId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;9d706dfc-a44a-4341-9cac-e995cc8a1530&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                        <span class="s">&quot;permissions&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                            <span class="s">&quot;secrets&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span>
</span><span class='line'>                                <span class="s">&quot;all&quot;</span>
</span><span class='line'>                            <span class="p-Indicator">]</span>
</span><span class='line'>                        <span class="p-Indicator">},</span>
</span><span class='line'>                        <span class="s">&quot;tenantId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;72f988bf-86f1-41af-91ab-2d7cd011db47&quot;</span>
</span><span class='line'>                    <span class="p-Indicator">}</span>
</span><span class='line'>                <span class="p-Indicator">],</span>
</span><span class='line'>                <span class="s">&quot;enabledForDeployment&quot;</span><span class="p-Indicator">:</span> <span class="nv">true</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;provisioningState&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Succeeded&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;sku&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;family&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;A&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;standard&quot;</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;tenantId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;72f988bf-86f1-41af-91ab-2d7cd011db47&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;vaultUri&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;https://labxxxx9607.vault.azure.net/&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="s">&quot;tags&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;CreatedBy&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;DevTestLabs&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;hidden-DevTestLabs-LabUId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;1f33aff8-4e19-43e2-b2fc-181ce85afd2a&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.KeyVault/vaults&quot;</span>
</span><span class='line'>        <span class="p-Indicator">},</span>
</span><span class='line'>        <span class="p-Indicator">{</span>
</span><span class='line'>            <span class="s">&quot;etag&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;W/\&quot;806f86f0-0cdd-4424-9fbc-17b9ab331ad7\&quot;&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Network/virtualNetworks/vnxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;location&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;vnxxxx&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;properties&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;addressSpace&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;addressPrefixes&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span>
</span><span class='line'>                        <span class="s">&quot;10.0.0.0/20&quot;</span>
</span><span class='line'>                    <span class="p-Indicator">]</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;dhcpOptions&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;dnsServers&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;enableDdosProtection&quot;</span><span class="p-Indicator">:</span> <span class="nv">false</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;enableVmProtection&quot;</span><span class="p-Indicator">:</span> <span class="nv">false</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;provisioningState&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Succeeded&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;resourceGuid&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;9f622d47-478c-44a1-9796-3ba51eb44259&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;subnets&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span>
</span><span class='line'>                    <span class="p-Indicator">{</span>
</span><span class='line'>                        <span class="s">&quot;etag&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;W/\&quot;806f86f0-0cdd-4424-9fbc-17b9ab331ad7\&quot;&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                        <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Network/virtualNetworks/vnxxxx/subnets/vnxxxxSubnet&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                        <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;vnxxxxSubnet&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                        <span class="s">&quot;properties&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                            <span class="s">&quot;addressPrefix&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;10.0.0.0/20&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                            <span class="s">&quot;delegations&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[],</span>
</span><span class='line'>                            <span class="s">&quot;provisioningState&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Succeeded&quot;</span>
</span><span class='line'>                        <span class="p-Indicator">},</span>
</span><span class='line'>                        <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.Network/virtualNetworks/subnets&quot;</span>
</span><span class='line'>                    <span class="p-Indicator">}</span>
</span><span class='line'>                <span class="p-Indicator">],</span>
</span><span class='line'>                <span class="s">&quot;virtualNetworkPeerings&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="s">&quot;tags&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;hidden-DevTestLabs-LabUId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;1f33aff8-4e19-43e2-b2fc-181ce85afd2a&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.Network/virtualNetworks&quot;</span>
</span><span class='line'>        <span class="p-Indicator">},</span>
</span><span class='line'>        <span class="p-Indicator">{</span>
</span><span class='line'>            <span class="s">&quot;id&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdtl/providers/Microsoft.Storage/storageAccounts/alabxxxx2409&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;kind&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;StorageV2&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;location&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;alabxxxx2409&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>            <span class="s">&quot;properties&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;accessTier&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Hot&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;creationTime&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;2019-03-01T08:43:18.0722775Z&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;encryption&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;keySource&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.Storage&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;services&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                        <span class="s">&quot;blob&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                            <span class="s">&quot;enabled&quot;</span><span class="p-Indicator">:</span> <span class="nv">true</span><span class="p-Indicator">,</span>
</span><span class='line'>                            <span class="s">&quot;lastEnabledTime&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;2019-03-01T08:43:18.1972664Z&quot;</span>
</span><span class='line'>                        <span class="p-Indicator">},</span>
</span><span class='line'>                        <span class="s">&quot;file&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                            <span class="s">&quot;enabled&quot;</span><span class="p-Indicator">:</span> <span class="nv">true</span><span class="p-Indicator">,</span>
</span><span class='line'>                            <span class="s">&quot;lastEnabledTime&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;2019-03-01T08:43:18.1972664Z&quot;</span>
</span><span class='line'>                        <span class="p-Indicator">}</span>
</span><span class='line'>                    <span class="p-Indicator">}</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;networkAcls&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;bypass&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;AzureServices&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;defaultAction&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Allow&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;ipRules&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[],</span>
</span><span class='line'>                    <span class="s">&quot;virtualNetworkRules&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;primaryEndpoints&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                    <span class="s">&quot;blob&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;https://alabxxxx2409.blob.core.windows.net/&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;dfs&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;https://alabxxxx2409.dfs.core.windows.net/&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;file&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;https://alabxxxx2409.file.core.windows.net/&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;queue&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;https://alabxxxx2409.queue.core.windows.net/&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;table&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;https://alabxxxx2409.table.core.windows.net/&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                    <span class="s">&quot;web&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;https://alabxxxx2409.z13.web.core.windows.net/&quot;</span>
</span><span class='line'>                <span class="p-Indicator">},</span>
</span><span class='line'>                <span class="s">&quot;primaryLocation&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;eastus&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;provisioningState&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Succeeded&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;statusOfPrimary&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;available&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;supportsHttpsTrafficOnly&quot;</span><span class="p-Indicator">:</span> <span class="nv">true</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="s">&quot;sku&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;name&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Standard_LRS&quot;</span><span class="p-Indicator">,</span>
</span><span class='line'>                <span class="s">&quot;tier&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Standard&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="s">&quot;tags&quot;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
</span><span class='line'>                <span class="s">&quot;hidden-DevTestLabs-LabUId&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;1f33aff8-4e19-43e2-b2fc-181ce85afd2a&quot;</span>
</span><span class='line'>            <span class="p-Indicator">},</span>
</span><span class='line'>            <span class="s">&quot;type&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Microsoft.Storage/storageAccounts&quot;</span>
</span><span class='line'>        <span class="p-Indicator">}</span>
</span><span class='line'>    <span class="p-Indicator">]</span>
</span><span class='line'><span class="err">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">PLAY RECAP ******************************************************************************************************************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">localhost</span>                  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ok=8    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[New Azure Virtual Machine Scale Set Features Support in Ansible]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/22/new-azure-virtual-machine-scale-set-features-support-in-ansible/"/>
    <updated>2019-03-22T09:02:01+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/22/new-azure-virtual-machine-scale-set-features-support-in-ansible</id>
    <content type="html"><![CDATA[
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[New Ansible Modules to Manage Azure DevTest Lab]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/22/new-ansible-modules-to-manage-azure-devtest-lab/"/>
    <updated>2019-03-22T09:01:02+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/22/new-ansible-modules-to-manage-azure-devtest-lab</id>
    <content type="html"><![CDATA[<p>The new sample containing tasks to create and manage Azure DevTest Lab is available here:</p>

<p><a href="https://github.com/Azure-Samples/ansible-playbooks/blob/master/devtestlab-create.yml">https://github.com/Azure-Samples/ansible-playbooks/blob/master/devtestlab-create.yml</a></p>

<p>This sample will:</p>

<ul>
<li>create resource group</li>
<li>create DevTest Lab</li>
<li>create sample DevTest Lab policy</li>
<li>create sample DevTest Lab schedule</li>
<li>create sample DevTest Lab Virtual Network</li>
<li>create sample DevTest Lab artifact source</li>
<li>create instance of DTL Virtual Machine</li>
<li>list all artifact sources</li>
<li>get artifacts source facts</li>
<li>list ARM Template facts</li>
<li>get ARM Template facts</li>
<li>create instance of DevTest Lab Environment</li>
<li>create instance of DevTest Lab Image</li>
<li>delete instance of Lab</li>
</ul>


<h2>Running the sample</h2>

<h2>Variables</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myLab</span>
</span><span class='line'>    <span class="l-Scalar-Plain">vn_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myLabVirtualNetwork</span>
</span><span class='line'>    <span class="l-Scalar-Plain">vm_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myLabVm</span>
</span><span class='line'>    <span class="l-Scalar-Plain">artifacts_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myArtifacts</span>
</span><span class='line'>    <span class="l-Scalar-Plain">github_token</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;env&#39;,&#39;GITHUB_ACCESS_TOKEN&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eastus</span>
</span></code></pre></td></tr></table></div></figure>


<p>Following variables can be set in <strong>vars</strong> section of the playbook:</p>

<table>
<thead>
<tr>
<th>Variable Name</th>
<th>Description</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>resource_group</td>
<td>resource group where resources will be created</td>
<td>by default it&rsquo;s using <strong>resource_group_name</strong> parameter passed when running the playbook</td>
</tr>
<tr>
<td>location</td>
<td>location where resources should be created</td>
<td></td>
</tr>
<tr>
<td>lab_name</td>
<td>name of the lab instance</td>
<td></td>
</tr>
<tr>
<td>vn_name</td>
<td>lab virtual network name</td>
<td></td>
</tr>
<tr>
<td>vm_name</td>
<td>name of the vm instance</td>
<td></td>
</tr>
<tr>
<td>artifacts_name</td>
<td>lab artifacts name</td>
<td></td>
</tr>
<tr>
<td>github_token</td>
<td>GitHub token to access artifacts sources</td>
<td>by default playbook will attempt to get it from GITHUB_ACCESS_TOKEN environment variable</td>
</tr>
</tbody>
</table>


<h2>Create Resource Group</h2>

<p>This simple task creates a resource group if doesn&rsquo;t exist yet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create a resource group</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_resourcegroup</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">location</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating DevTest Lab</h2>

<p>This task creates an instance of DevTest Lab.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance of Lab</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_devtestlab</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">location</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">standard</span>
</span><span class='line'>    <span class="l-Scalar-Plain">premium_data_disks</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">no</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output_lab</span>
</span></code></pre></td></tr></table></div></figure>


<h2>DevTest Lab Policies</h2>

<p>This task shows how to set up DevTest Lab policy settings.</p>

<p>Following values can be set:</p>

<table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>user_owned_lab_vm_count</td>
<td>count of VMs that can be owned by an user</td>
</tr>
<tr>
<td>user_owned_lab_premium_vm_count</td>
<td>count of premium VMs that can be owned by an user</td>
</tr>
<tr>
<td>lab_vm_count</td>
<td>maximum lab VM count</td>
</tr>
<tr>
<td>lab_premium_vm_count</td>
<td>maximum lab premium VM count</td>
</tr>
<tr>
<td>lab_vm_size</td>
<td>allowed lab VMs size(s)</td>
</tr>
<tr>
<td>gallery_image</td>
<td>allowed gallery image(s)</td>
</tr>
<tr>
<td>user_owned_lab_vm_count_in_subnet</td>
<td>maximum number of user&rsquo;s VMs in a subnet</td>
</tr>
<tr>
<td>lab_target_cost</td>
<td>target cost of the lab</td>
</tr>
</tbody>
</table>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance of DevTest Lab Policy</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_devtestlabpolicy</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">policy_set_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myDtlPolicySet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myDtlPolicy</span>
</span><span class='line'>    <span class="l-Scalar-Plain">fact_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">user_owned_lab_vm_count</span>
</span><span class='line'>    <span class="l-Scalar-Plain">threshold</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span></code></pre></td></tr></table></div></figure>


<h2>DevTest Lab Schedules</h2>

<p>Sample task setting DevTest Lab VM schedule.</p>

<p>Currently allowed are:
|Name|Description|
|&mdash;-|&mdash;&mdash;&mdash;&ndash;|
|lab_vms_startup|Lab VMs startup time|
|lab_vms_shutdown|Lab VMs shutdown time|</p>

<p>Time and time zone id must be specified.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance of DevTest Lab Schedule</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_devtestlabschedule</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lab_vms_shutdown</span>
</span><span class='line'>        <span class="l-Scalar-Plain">time</span><span class="p-Indicator">:</span> <span class="s">&quot;1030&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">time_zone_id</span><span class="p-Indicator">:</span> <span class="s">&quot;UTC+12&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<h2>DevTest Lab Virtual Network</h2>

<p>This task creates default DevTest Lab virtual network.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance of DevTest Labs virtual network</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_devtestlabvirtualnetwork</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vn_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">location</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My DevTest Lab Virtual Network</span>
</span><span class='line'>      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<h2>DevTest Lab Artifact Source</h2>

<p>This task shows how to create DevTest Lab artifacts source.
DevTest Lab artifacts source is properly structured GitHub repository that contains artifact definition and ARM templates.
Please note that every lab comes with predefined public artifacts source.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance of DevTest Labs artifacts source</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_devtestlabartifactsource</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">artifacts_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">uri</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/Azure/azure_preview_modules.git</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">github</span>
</span><span class='line'>        <span class="l-Scalar-Plain">folder_path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/tasks</span>
</span><span class='line'>        <span class="l-Scalar-Plain">security_token</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">github_token</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>DevTest Lab Virtual Machine</h2>

<p>This task shows how to create DevTest Labs virtual machine.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance of DTL Virtual Machine</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_devtestlabvirtualmachine</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vm_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">notes</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Virtual machine notes, just something....</span>
</span><span class='line'>    <span class="l-Scalar-Plain">os_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>    <span class="l-Scalar-Plain">vm_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Standard_A2_v2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">user_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dtladmin</span>
</span><span class='line'>    <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ZSasfovobocu$$21!</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lab_subnet</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">virtual_network_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vn_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vn_name</span><span class="nv"> </span><span class="s">}}Subnet&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">disallow_public_ip_address</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">no</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">offer</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">UbuntuServer</span>
</span><span class='line'>      <span class="l-Scalar-Plain">publisher</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Canonical</span>
</span><span class='line'>      <span class="l-Scalar-Plain">sku</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">16.04-LTS</span>
</span><span class='line'>      <span class="l-Scalar-Plain">os_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">artifacts</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">source_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">artifacts_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source_path</span><span class="p-Indicator">:</span> <span class="s">&quot;/Artifacts/linux-install-mongodb&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">allow_claim</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">no</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expiration_date</span><span class="p-Indicator">:</span> <span class="s">&quot;2029-02-22T01:49:12.117974Z&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Listing All Artifact Sources and Artifacts</h2>

<p>This task lists all artifacts sources in the lab.
Please use it to see default and custom artifacts sources.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">List all artifact sources</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_devtestlabartifactsource_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>Following task lists all the artifact in <strong>public repo</strong> which is predefined artifact source.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Get artifacts source facts</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_devtestlabartifact_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">artifact_source_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">public repo</span>
</span><span class='line'>      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Getting Information on ARM Templates in Artifact Source</h2>

<p>This task lists all the ARM templates in <strong>public environment repo</strong> that is predefined repo with templates.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">List ARM Template facts</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_devtestlabarmtemplate_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">artifact_source_name</span><span class="p-Indicator">:</span> <span class="s">&quot;public</span><span class="nv"> </span><span class="s">environment</span><span class="nv"> </span><span class="s">repo&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>And following task retrieves details of a specific ARM template from the repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Get ARM Template facts</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_devtestlabarmtemplate_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">artifact_source_name</span><span class="p-Indicator">:</span> <span class="s">&quot;public</span><span class="nv"> </span><span class="s">environment</span><span class="nv"> </span><span class="s">repo&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ServiceFabric-LabCluster</span>
</span><span class='line'>      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating DevTest Lab Environment</h2>

<p>Finally following task creates DevTest Lab environment. As you see it refers one of the templates from <strong>public environment repo</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance of DevTest Lab Environment</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_devtestlabenvironment</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">user_name</span><span class="p-Indicator">:</span> <span class="s">&quot;@me&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myEnvironment</span>
</span><span class='line'>        <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eastus</span>
</span><span class='line'>        <span class="l-Scalar-Plain">deployment_template</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">output_lab.id</span><span class="nv"> </span><span class="s">}}/artifactSources/public</span><span class="nv"> </span><span class="s">environment</span><span class="nv"> </span><span class="s">repo/armTemplates/WebApp&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating DevTest Lab Image</h2>

<p>This is also a very useful task. It creates DevTest Lab image from existing DevTest Lab Virtual Machine.
It can be later used to created new DevTest Lab virtual machines.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance of DevTest Lab Image</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_devtestlabcustomimage</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">lab_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myImage</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source_vm</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">output_vm.virtualmachines[0][&#39;name&#39;]</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">linux_os_state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">non_deprovisioned</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deleting the Lab</h2>

<p>Final task deletes entire lab.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Delete instance of Lab</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_devtestlab</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lab_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">absent</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Assert the change was correctly reported</span>
</span><span class='line'>  <span class="l-Scalar-Plain">assert</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">that</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">output.changed</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[New Ansible Module Azure_rm_hdinsightcluster]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/22/new-ansible-module-azure-rm-hdinsightcluster/"/>
    <updated>2019-03-22T09:00:35+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/22/new-ansible-module-azure-rm-hdinsightcluster</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/Azure-Samples/ansible-playbooks/blob/master/hdinsight-create.yml">https://github.com/Azure-Samples/ansible-playbooks/blob/master/hdinsight-create.yml</a></p>

<p>This sample will:</p>

<ul>
<li>create resource group</li>
<li>create storage account</li>
<li>obtain storage account keys required by the cluster</li>
<li>create HDInsight cluster</li>
<li>resize cluster</li>
<li>delete cluster</li>
</ul>


<h2>Create Random Prefix</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Prepare random prefix</span>
</span><span class='line'>      <span class="l-Scalar-Plain">set_fact</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">rpfx</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group_name</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">hash(&#39;md5&#39;)</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">truncate(7,</span><span class="nv"> </span><span class="s">True,</span><span class="nv"> </span><span class="s">&#39;&#39;)</span><span class="nv"> </span><span class="s">}}{{</span><span class="nv"> </span><span class="s">1000</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">random</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run_once</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Variables</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eastus</span>
</span><span class='line'>    <span class="l-Scalar-Plain">vnet_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myVirtualNetwork</span>
</span><span class='line'>    <span class="l-Scalar-Plain">subnet_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mySubnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cluster_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mycluster{{ rpfx }}</span>
</span><span class='line'>    <span class="l-Scalar-Plain">storage_account_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mystorage{{ rpfx }}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create Resource Group</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create a resource group</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_resourcegroup</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">location</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create Storage Account and Obtain Keys</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create storage account</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_storageaccount</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">storage_account_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">account_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Standard_LRS</span>
</span><span class='line'>      <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eastus2</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Get storage account keys</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="s">&#39;2018-07-01&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">method</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">POST</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">storage</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">storageaccounts</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">storage_account_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">subresource</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">listkeys</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">storage_output</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">storage_output</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create Instance of HDInsight Cluster</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance of Cluster</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_hdinsightcluster</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cluster_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eastus2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cluster_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3.6</span>
</span><span class='line'>    <span class="l-Scalar-Plain">os_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>    <span class="l-Scalar-Plain">tier</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">standard</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cluster_definition</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">spark</span>
</span><span class='line'>      <span class="l-Scalar-Plain">gateway_rest_username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http-user</span>
</span><span class='line'>      <span class="l-Scalar-Plain">gateway_rest_password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MuABCPassword!!@123</span>
</span><span class='line'>    <span class="l-Scalar-Plain">storage_accounts</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">storage_account_name</span><span class="nv"> </span><span class="s">}}.blob.core.windows.net&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">is_default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>        <span class="l-Scalar-Plain">container</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cluster_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">key</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">storage_output[&#39;response&#39;][&#39;keys&#39;][0][&#39;value&#39;]</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">compute_profile_roles</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">headnode</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target_instance_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>        <span class="l-Scalar-Plain">vm_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Standard_D3</span>
</span><span class='line'>        <span class="l-Scalar-Plain">linux_profile</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sshuser</span>
</span><span class='line'>          <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MuABCPassword!!@123</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">workernode</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target_instance_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>        <span class="l-Scalar-Plain">vm_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Standard_D3</span>
</span><span class='line'>        <span class="l-Scalar-Plain">linux_profile</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sshuser</span>
</span><span class='line'>          <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MuABCPassword!!@123</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zookeepernode</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target_instance_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>        <span class="l-Scalar-Plain">vm_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Medium</span>
</span><span class='line'>        <span class="l-Scalar-Plain">linux_profile</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sshuser</span>
</span><span class='line'>          <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MuABCPassword!!@123</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resize Cluster</h2>

<p>The only thing that can be changed after HDInsight cluster is created is the number of worker nodes.
Below task will increment number of nodes from 1 to 2.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Resize cluster</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_hdinsightcluster</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cluster_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eastus2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cluster_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3.6</span>
</span><span class='line'>    <span class="l-Scalar-Plain">os_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>    <span class="l-Scalar-Plain">tier</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">standard</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cluster_definition</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">spark</span>
</span><span class='line'>      <span class="l-Scalar-Plain">gateway_rest_username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http-user</span>
</span><span class='line'>      <span class="l-Scalar-Plain">gateway_rest_password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MuABCPassword!!@123</span>
</span><span class='line'>    <span class="l-Scalar-Plain">storage_accounts</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">storage_account_name</span><span class="nv"> </span><span class="s">}}.blob.core.windows.net&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">is_default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>        <span class="l-Scalar-Plain">container</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cluster_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">key</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">storage_output[&#39;response&#39;][&#39;keys&#39;][0][&#39;value&#39;]</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">compute_profile_roles</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">headnode</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target_instance_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>        <span class="l-Scalar-Plain">vm_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Standard_D3</span>
</span><span class='line'>        <span class="l-Scalar-Plain">linux_profile</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sshuser</span>
</span><span class='line'>          <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MuABCPassword!!@123</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">workernode</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target_instance_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>        <span class="l-Scalar-Plain">vm_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Standard_D3</span>
</span><span class='line'>        <span class="l-Scalar-Plain">linux_profile</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sshuser</span>
</span><span class='line'>          <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MuABCPassword!!@123</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zookeepernode</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target_instance_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>        <span class="l-Scalar-Plain">vm_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Medium</span>
</span><span class='line'>        <span class="l-Scalar-Plain">linux_profile</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sshuser</span>
</span><span class='line'>          <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MuABCPassword!!@123</span>
</span><span class='line'>    <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">aaa</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bbb</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Clean Up</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Delete instance of Cluster</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_hdinsightcluster</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cluster_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">absent</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[New Ansible Module Azure_rm_cosmosdbaccount]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/22/new-ansible-module-azure-rm-cosmosdbaccount/"/>
    <updated>2019-03-22T09:00:13+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/22/new-ansible-module-azure-rm-cosmosdbaccount</id>
    <content type="html"><![CDATA[<p>Cosmos DB Account sample is available here:</p>

<p><a href="https://github.com/Azure-Samples/ansible-playbooks/blob/master/cosmosdb-create.yml">https://github.com/Azure-Samples/ansible-playbooks/blob/master/cosmosdb-create.yml</a></p>

<p>This sample:</p>

<ul>
<li>creates random postfix to use in CosmosDB account name</li>
<li>creates resource group</li>
<li>creates virtual network</li>
<li>creates subnet</li>
<li>creates CosmosDB account</li>
<li>queries and prints CosmosDB keys</li>
</ul>


<h2>Create Random Postfix</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Prepare random postfix</span>
</span><span class='line'>      <span class="l-Scalar-Plain">set_fact</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">rpfx</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">1000</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">random</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run_once</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Variables</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eastus</span>
</span><span class='line'>    <span class="l-Scalar-Plain">vnet_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myVirtualNetwork</span>
</span><span class='line'>    <span class="l-Scalar-Plain">subnet_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mySubnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cosmosdbaccount_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cosmos{{ rpfx }}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Following variables can be set in <strong>vars</strong> section of the playbook:</p>

<table>
<thead>
<tr>
<th>Variable Name</th>
<th>Description</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>resource_group</td>
<td>resource group where resources will be created</td>
<td>by default it&rsquo;s using <strong>resource_group_name</strong> parameter passed when running the playbook</td>
</tr>
<tr>
<td>location</td>
<td>location where resources should be created</td>
<td></td>
</tr>
<tr>
<td>vnet_name</td>
<td>virtual network name</td>
<td></td>
</tr>
<tr>
<td>subnet</td>
<td>subnet name</td>
<td></td>
</tr>
<tr>
<td>cosmosdbaccount_name</td>
<td>CosmosDB account name</td>
<td>should include only lowercase characters and be globally unique</td>
</tr>
</tbody>
</table>


<h2>Create Resource Group</h2>

<p>This simple task creates a resource group if doesn&rsquo;t exist yet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create a resource group</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_resourcegroup</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">location</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create Virtual Network and Subnet</h2>

<p>This task created prerequisites for CosmosDB account:</p>

<ul>
<li>virtual network</li>
<li>subnet</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create virtual network</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_virtualnetwork</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vnet_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">address_prefixes_cidr</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">10.1.0.0/16</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">172.100.0.0/16</span>
</span><span class='line'>    <span class="l-Scalar-Plain">dns_servers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">127.0.0.1</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">127.0.0.3</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add subnet</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_subnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">subnet_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">virtual_network_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vnet_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">address_prefix_cidr</span><span class="p-Indicator">:</span> <span class="s">&quot;10.1.0.0/24&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create CosmosDB Account</h2>

<p>This task creates actual CosmosDB account.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance of Cosmos DB Account</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_cosmosdbaccount</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cosmosdbaccount_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">location</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">global_document_db</span>
</span><span class='line'>    <span class="l-Scalar-Plain">geo_rep_locations</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eastus</span>
</span><span class='line'>        <span class="l-Scalar-Plain">failover_priority</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">westus</span>
</span><span class='line'>        <span class="l-Scalar-Plain">failover_priority</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>    <span class="l-Scalar-Plain">database_account_offer_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Standard</span>
</span><span class='line'>    <span class="l-Scalar-Plain">is_virtual_network_filter_enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>    <span class="l-Scalar-Plain">virtual_network_rules</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">subnet</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>          <span class="l-Scalar-Plain">virtual_network_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vnet_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>          <span class="l-Scalar-Plain">subnet_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">subnet_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ignore_missing_vnet_service_endpoint</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enable_automatic_failover</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Retrieve Keys</h2>

<p>This task shows how to retrieve CosmosDB account keys that should be used later by any application using the database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Get Cosmos DB Account facts with keys</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_cosmosdbaccount_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">resource_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cosmosdbaccount_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">retrieve_keys</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Display Cosmos DB Acccount facts output</span>
</span><span class='line'>  <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Use in your application</h2>

<p>&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Note on Ansible Examples]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/19/note-on-ansible-examples/"/>
    <updated>2019-03-19T06:42:26+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/19/note-on-ansible-examples</id>
    <content type="html"><![CDATA[<p>When I started working with Ansible I wa</p>

<p>Let&rsquo;s do following exercise. I want to create an Azure Virtual Machine using examples from documentation.</p>

<p>Let&rsquo;s start with default virtual machine example (<a href="https://docs.ansible.com/ansible/latest/modules/azure_rm_virtualmachine_module.html">https://docs.ansible.com/ansible/latest/modules/azure_rm_virtualmachine_module.html</a>)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Azure VM using default samples</span>
</span><span class='line'>  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create VM with defaults</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_virtualmachine</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Testing</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">testvm10</span>
</span><span class='line'>        <span class="l-Scalar-Plain">admin_username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chouseknecht</span>
</span><span class='line'>        <span class="l-Scalar-Plain">admin_password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;your password here&gt;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">offer</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">CentOS</span>
</span><span class='line'>          <span class="l-Scalar-Plain">publisher</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">OpenLogic</span>
</span><span class='line'>          <span class="l-Scalar-Plain">sku</span><span class="p-Indicator">:</span> <span class="s">&#39;7.1&#39;</span>
</span><span class='line'>          <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">latest</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, Ansible will complain that resource group <strong>Testing</strong> is not present, so I add resource group from here <a href="https://docs.ansible.com/ansible/latest/modules/azure_rm_resourcegroup_module.html:">https://docs.ansible.com/ansible/latest/modules/azure_rm_resourcegroup_module.html:</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Azure VM using default samples</span>
</span><span class='line'>  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create a resource group</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_resourcegroup</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Testing</span>
</span><span class='line'>        <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">westus</span>
</span><span class='line'>        <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">testing</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">testing</span>
</span><span class='line'>          <span class="l-Scalar-Plain">delete</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">never</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create VM with defaults</span>
</span><span class='line'>      <span class="l-Scalar-Plain">azure_rm_virtualmachine</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Testing</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">testvm10</span>
</span><span class='line'>        <span class="l-Scalar-Plain">admin_username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chouseknecht</span>
</span><span class='line'>        <span class="l-Scalar-Plain">admin_password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;your password here&gt;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">offer</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">CentOS</span>
</span><span class='line'>          <span class="l-Scalar-Plain">publisher</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">OpenLogic</span>
</span><span class='line'>          <span class="l-Scalar-Plain">sku</span><span class="p-Indicator">:</span> <span class="s">&#39;7.1&#39;</span>
</span><span class='line'>          <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">latest</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Removing Resource Locks Using Ansible and Azure REST API]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/18/removing-resource-locks-using-ansible-and-azure-rest-api/"/>
    <updated>2019-03-18T14:51:20+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/18/removing-resource-locks-using-ansible-and-azure-rest-api</id>
    <content type="html"><![CDATA[<p>This is one of the topic I had to look into. Removing locks appeared to be an issue while performing automatic clean up of the resources.</p>

<p>Currently there&rsquo;s no support for locks in Ansible, but I have tried to use <strong>azure_rm_resource_facts</strong> module to list locks on both resource group and subscription level, and then delete locks using <strong>azure_rm_resource</strong>.</p>

<p>To list all the locks in the resource group:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">List all the locks in the resource group</span>
</span><span class='line'>    <span class="l-Scalar-Plain">azure_rm_resource_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="s">&#39;2016-09-01&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">authorization</span>
</span><span class='line'>      <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">locks</span>
</span><span class='line'>    <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>or all resources in the subscription, just remove <strong>resource_group</strong> parameter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">List all the locks in the resource group</span>
</span><span class='line'>    <span class="l-Scalar-Plain">azure_rm_resource_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="s">&#39;2016-09-01&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">authorization</span>
</span><span class='line'>      <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">locks</span>
</span><span class='line'>    <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output will look as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;output&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;changed&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;failed&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;response&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimslockedrg/providers/Microsoft.Network/virtualNetworks/zimslockedvb/providers/Microsoft.Authorization/locks/justalock&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;justalock&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nt">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;CanNotDelete&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;notes&quot;</span><span class="p">:</span> <span class="s2">&quot;blabla&quot;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Authorization/locks&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimslockedrg/providers/Microsoft.authorization/locks&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="s2">&quot;Azure API profile latest does not define an entry for GenericRestClient&quot;</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Based on this output you can just delete all the locks one by one using <strong>azure_rm_resource</strong> module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Delete locks one by one</span>
</span><span class='line'>    <span class="l-Scalar-Plain">azure_rm_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="s">&#39;2016-09-01&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">authorization</span>
</span><span class='line'>      <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">locks</span>
</span><span class='line'>      <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">absent</span>
</span><span class='line'>    <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note that there&rsquo;s a bug in the versions of Ansible earlier than 2.8, and the last playbook needs small modification:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Delete locks one by one</span>
</span><span class='line'>    <span class="l-Scalar-Plain">azure_rm_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="s">&#39;2016-09-01&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">authorization</span>
</span><span class='line'>      <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">locks</span>
</span><span class='line'>      <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">absent</span>
</span><span class='line'>    <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ansible and Azure Function Apps]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/07/ansible-and-azure-function-apps/"/>
    <updated>2019-03-07T22:07:46+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/07/ansible-and-azure-function-apps</id>
    <content type="html"><![CDATA[<p>This is something I was planning to investigate for some time. We have <strong>azure_rm_functionapp</strong> module, but it seems to be very limited. Actually I don&rsquo;t really know what it creates.</p>

<p>I decided to reverse engineer a very simple scenario - creating a container based function app through Azure Portal.</p>

<p>The best way to figure out what was created is to use following playbook to list all the resources in the resource group:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">List all the resources in the resource group</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_resource_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="s">&#39;2018-05-01&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zimsfunctionapp</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">resources</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>Inside response I found following list of resources:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsfunctionapp/providers/Microsoft.Web/sites/zimsfunctionapp&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;functionapp,linux,container&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;westus&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsfunctionapp&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Web/sites&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I can do another query to get more details:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Get WebApp information</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_resource_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="s">&#39;2016-08-01&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zimsfunctionapp</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sites</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zimsfunctionapp</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that returs following large structure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsfunctionapp/providers/Microsoft.Web/sites/zimsfunctionapp&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;functionapp,linux,container&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;West US&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsfunctionapp&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;adminEnabled&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;availabilityState&quot;</span><span class="p">:</span> <span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;cers&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;clientAffinityEnabled&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;clientCertEnabled&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;clientCertExclusionPaths&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;cloningInfo&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;computeMode&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;containerSize&quot;</span><span class="p">:</span> <span class="mi">1536</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;contentAvailabilityState&quot;</span><span class="p">:</span> <span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;csrs&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span class='line'>            <span class="nt">&quot;dailyMemoryTimeQuota&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;defaultHostName&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsfunctionapp.azurewebsites.net&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;deploymentId&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsfunctionapp&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;domainVerificationIdentifiers&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;enabledHostNames&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;zimsfunctionapp.azurewebsites.net&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;zimsfunctionapp.scm.azurewebsites.net&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;functionExecutionUnitsCache&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;geoDistributions&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;homeStamp&quot;</span><span class="p">:</span> <span class="s2">&quot;waws-prod-bay-081&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;hostNameSslStates&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="nt">&quot;hostType&quot;</span><span class="p">:</span> <span class="s2">&quot;Standard&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;ipBasedSslResult&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;ipBasedSslState&quot;</span><span class="p">:</span> <span class="s2">&quot;NotConfigured&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsfunctionapp.azurewebsites.net&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;sslState&quot;</span><span class="p">:</span> <span class="s2">&quot;Disabled&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;thumbprint&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;toUpdate&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;toUpdateIpBasedSsl&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;virtualIP&quot;</span><span class="p">:</span> <span class="kc">null</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="nt">&quot;hostType&quot;</span><span class="p">:</span> <span class="s2">&quot;Repository&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;ipBasedSslResult&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;ipBasedSslState&quot;</span><span class="p">:</span> <span class="s2">&quot;NotConfigured&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsfunctionapp.scm.azurewebsites.net&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;sslState&quot;</span><span class="p">:</span> <span class="s2">&quot;Disabled&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;thumbprint&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;toUpdate&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;toUpdateIpBasedSsl&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;virtualIP&quot;</span><span class="p">:</span> <span class="kc">null</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;hostNames&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;zimsfunctionapp.azurewebsites.net&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;hostNamesDisabled&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;hostingEnvironment&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;hostingEnvironmentId&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;hostingEnvironmentProfile&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;httpsOnly&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;hyperV&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;inProgressOperationId&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;isXenon&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;functionapp,linux,container&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;lastModifiedTimeUtc&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-03-07T13:52:14.7033333&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;maxNumberOfWorkers&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsfunctionapp&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;outboundIpAddresses&quot;</span><span class="p">:</span> <span class="s2">&quot;13.64.73.110,40.118.133.8,40.118.169.141,40.118.253.162,13.64.147.140&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;owner&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;possibleOutboundIpAddresses&quot;</span><span class="p">:</span> <span class="s2">&quot;13.64.73.110,40.118.133.8,40.118.169.141,40.118.253.162,13.64.147.140,52.160.85.217,13.93.238.69&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;redundancyMode&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;repositorySiteName&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsfunctionapp&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;reserved&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;resourceGroup&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsfunctionapp&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;runtimeAvailabilityState&quot;</span><span class="p">:</span> <span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;scmSiteAlsoStopped&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;selfLink&quot;</span><span class="p">:</span> <span class="s2">&quot;https://waws-prod-bay-081.api.azurewebsites.windows.net:454/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/webspaces/jw-webapp-linux-nginx-06-WestUSwebspace/sites/zimsfunctionapp&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;serverFarm&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;serverFarmId&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/jw-webapp-linux-nginx-06/providers/Microsoft.Web/serverfarms/jw-webapp-linux-plan-01&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;siteConfig&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;siteDisabledReason&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;siteMode&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;siteProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;appSettings&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                    <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;LinuxFxVersion&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;DOCKER|httpd&quot;</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>                    <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;WindowsFxVersion&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">]</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="nt">&quot;sku&quot;</span><span class="p">:</span> <span class="s2">&quot;Standard&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;slotSwapStatus&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;sslCertificates&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;Running&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;storageRecoveryDefaultState&quot;</span><span class="p">:</span> <span class="s2">&quot;Running&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;suspendedTill&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;targetSwapSlot&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;trafficManagerHostNames&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;usageState&quot;</span><span class="p">:</span> <span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;webSpace&quot;</span><span class="p">:</span> <span class="s2">&quot;jw-webapp-linux-nginx-06-WestUSwebspace&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Web/sites&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Diving Into Azure_rm_deployment]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/07/diving-into-azure-rm-deployment/"/>
    <updated>2019-03-07T10:40:24+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/07/diving-into-azure-rm-deployment</id>
    <content type="html"><![CDATA[<p>It&rsquo;s time to refresh <strong>azure_rm_deployment</strong>.</p>

<p>Currently we have following problems with <strong>azure_rm_deployment</strong></p>

<ul>
<li>it&rsquo;s a kind of VM oriented only</li>
<li>no proper facts module, no proper information about created resources, so it&rsquo;s difficult to build on the top of resources created by ARM deployment</li>
<li>deleting deployment actually deletes entire resource group, so no convenient way to have any additional resources in the same resource group</li>
<li>default deployment name (user can optionally specify) is confusing and inconsistent with other resources</li>
</ul>


<p>What we can fix, and it&rsquo;s quite easy:
- facts module that lists all the resource ids in dictionary by resource type
- properly deleting resources created by deployment, enabling users to have more than one deployment in a resource group</p>

<p>Let&rsquo;s start with a simple playbook. I have just taken it from integration tests:</p>

<h2>How it currently works?</h2>

<p>Just a simple playbook that creates a virtual machine:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Azure Deploy</span>
</span><span class='line'>    <span class="l-Scalar-Plain">azure_rm_deployment</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eastus2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">template_link</span><span class="p-Indicator">:</span> <span class="s">&#39;https://raw.githubusercontent.com/Azure/azure-quickstart-templates/d01a5c06f4f1bc03a049ca17bbbd6e06d62657b3/101-vm-simple-linux/azuredeploy.json&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deployment_name</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">adminUsername</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">value</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chouseknecht</span>
</span><span class='line'>        <span class="l-Scalar-Plain">adminPassword</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">value</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">password123!</span>
</span><span class='line'>        <span class="l-Scalar-Plain">dnsLabelPrefix</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">value</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ubuntuOSVersion</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">value</span><span class="p-Indicator">:</span> <span class="s">&quot;16.04.0-LTS&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>and the output looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;output&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;changed&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;deployment&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;group_name&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsdeployment&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdeployment/providers/Microsoft.Resources/deployments/zimsdeployment&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;instances&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="nt">&quot;ips&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;dns_settings&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;domain_name_label&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsdeployment&quot;</span><span class="p">,</span>
</span><span class='line'>                                <span class="nt">&quot;fqdn&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsdeployment.eastus2.cloudapp.azure.com&quot;</span>
</span><span class='line'>                            <span class="p">},</span>
</span><span class='line'>                            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/zimsdeployment/providers/Microsoft.Network/publicIPAddresses/myPublicIP&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;myPublicIP&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;public_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;23.100.65.195&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;public_ip_allocation_method&quot;</span><span class="p">:</span> <span class="s2">&quot;Dynamic&quot;</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">],</span>
</span><span class='line'>                    <span class="nt">&quot;vm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;MyUbuntuVM&quot;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsdeployment&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;hostname&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsdeployment.eastus2.cloudapp.azure.com&quot;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="nt">&quot;sshCommand&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh chouseknecht@zimsdeployment.eastus2.cloudapp.azure.com&quot;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;failed&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;deployment succeeded&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>What is actually returned by Azure REST API?</h2>

<p>I have created following task to find it out:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Get deployment</span>
</span><span class='line'>    <span class="l-Scalar-Plain">azure_rm_resource_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="s">&#39;2019-03-01&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">resources</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deployments</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_name</span><span class="p-Indicator">:</span>  <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you see below it actually returns quite a lot:
- list of all created resource IDs
- list of all dependencies between resources</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;output&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;changed&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;failed&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;response&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Resources/deployments/zimsdplxxxx&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsdplxxxx&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nt">&quot;correlationId&quot;</span><span class="p">:</span> <span class="s2">&quot;0c26c003-f147-4f18-95c6-a28e43630dd1&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;dependsOn&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                <span class="p">{</span>
</span><span class='line'>                                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Network/publicIPAddresses/myPublicIP&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceName&quot;</span><span class="p">:</span> <span class="s2">&quot;myPublicIP&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Network/publicIPAddresses&quot;</span>
</span><span class='line'>                                <span class="p">},</span>
</span><span class='line'>                                <span class="p">{</span>
</span><span class='line'>                                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Network/virtualNetworks/MyVNET&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceName&quot;</span><span class="p">:</span> <span class="s2">&quot;MyVNET&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Network/virtualNetworks&quot;</span>
</span><span class='line'>                                <span class="p">}</span>
</span><span class='line'>                            <span class="p">],</span>
</span><span class='line'>                            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Network/networkInterfaces/myVMNic&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;resourceName&quot;</span><span class="p">:</span> <span class="s2">&quot;myVMNic&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Network/networkInterfaces&quot;</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;dependsOn&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                <span class="p">{</span>
</span><span class='line'>                                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Storage/storageAccounts/iovbjgl443l64sawinvm&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceName&quot;</span><span class="p">:</span> <span class="s2">&quot;iovbjgl443l64sawinvm&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Storage/storageAccounts&quot;</span>
</span><span class='line'>                                <span class="p">},</span>
</span><span class='line'>                                <span class="p">{</span>
</span><span class='line'>                                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Network/networkInterfaces/myVMNic&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceName&quot;</span><span class="p">:</span> <span class="s2">&quot;myVMNic&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Network/networkInterfaces&quot;</span>
</span><span class='line'>                                <span class="p">}</span>
</span><span class='line'>                            <span class="p">],</span>
</span><span class='line'>                            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Compute/virtualMachines/SimpleWinVM&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;resourceName&quot;</span><span class="p">:</span> <span class="s2">&quot;SimpleWinVM&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Compute/virtualMachines&quot;</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">],</span>
</span><span class='line'>                    <span class="nt">&quot;duration&quot;</span><span class="p">:</span> <span class="s2">&quot;PT46.927468S&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;Incremental&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;outputResources&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Compute/virtualMachines/SimpleWinVM&quot;</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Network/networkInterfaces/myVMNic&quot;</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Network/publicIPAddresses/myPublicIP&quot;</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Network/virtualNetworks/MyVNET&quot;</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.Storage/storageAccounts/iovbjgl443l64sawinvm&quot;</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">],</span>
</span><span class='line'>                    <span class="nt">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;hostname&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsdplxxxx.eastus2.cloudapp.azure.com&quot;</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>                    <span class="nt">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;adminPassword&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SecureString&quot;</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;adminUsername&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;chouseknecht&quot;</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;dnsLabelPrefix&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;zimsdplxxxx&quot;</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;eastus2&quot;</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;windowsOSVersion&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-Datacenter&quot;</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>                    <span class="nt">&quot;providers&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Storage&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;resourceTypes&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                <span class="p">{</span>
</span><span class='line'>                                    <span class="nt">&quot;locations&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                        <span class="s2">&quot;eastus2&quot;</span>
</span><span class='line'>                                    <span class="p">],</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;storageAccounts&quot;</span>
</span><span class='line'>                                <span class="p">}</span>
</span><span class='line'>                            <span class="p">]</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Network&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;resourceTypes&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                <span class="p">{</span>
</span><span class='line'>                                    <span class="nt">&quot;locations&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                        <span class="s2">&quot;eastus2&quot;</span>
</span><span class='line'>                                    <span class="p">],</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;publicIPAddresses&quot;</span>
</span><span class='line'>                                <span class="p">},</span>
</span><span class='line'>                                <span class="p">{</span>
</span><span class='line'>                                    <span class="nt">&quot;locations&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                        <span class="s2">&quot;eastus2&quot;</span>
</span><span class='line'>                                    <span class="p">],</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;virtualNetworks&quot;</span>
</span><span class='line'>                                <span class="p">},</span>
</span><span class='line'>                                <span class="p">{</span>
</span><span class='line'>                                    <span class="nt">&quot;locations&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                        <span class="s2">&quot;eastus2&quot;</span>
</span><span class='line'>                                    <span class="p">],</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;networkInterfaces&quot;</span>
</span><span class='line'>                                <span class="p">}</span>
</span><span class='line'>                            <span class="p">]</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="p">{</span>
</span><span class='line'>                            <span class="nt">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Compute&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nt">&quot;resourceTypes&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                <span class="p">{</span>
</span><span class='line'>                                    <span class="nt">&quot;locations&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                                        <span class="s2">&quot;eastus2&quot;</span>
</span><span class='line'>                                    <span class="p">],</span>
</span><span class='line'>                                    <span class="nt">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;virtualMachines&quot;</span>
</span><span class='line'>                                <span class="p">}</span>
</span><span class='line'>                            <span class="p">]</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">],</span>
</span><span class='line'>                    <span class="nt">&quot;provisioningState&quot;</span><span class="p">:</span> <span class="s2">&quot;Succeeded&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;templateHash&quot;</span><span class="p">:</span> <span class="s2">&quot;17224794003184781395&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;templateLink&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;contentVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0.0&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;uri&quot;</span><span class="p">:</span> <span class="s2">&quot;https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/101-vm-simple-windows/azuredeploy.json&quot;</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>                    <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-03-07T05:49:05.3868647Z&quot;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Resources/deployments&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/1c5b82ee-9294-4568-b0c0-b9c523bc0d86/resourceGroups/zimsanotherdeployment/providers/Microsoft.resources/deployments/zimsdplxxxx&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="s2">&quot;Azure API profile latest does not define an entry for GenericRestClient&quot;</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ansible Modules - Proposed Improvements]]></title>
    <link href="http://zikalino.github.io/blog/2019/03/06/ansible-modules-proposed-improvements/"/>
    <updated>2019-03-06T08:03:07+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/03/06/ansible-modules-proposed-improvements</id>
    <content type="html"><![CDATA[<p>I have done a lot of experiments with Ansible module idempotence and here&rsquo;s a summary and a proposal of generic solution.</p>

<p>Let&rsquo;s start with problems we have:
- every module has their own idempotency checks so the behaviour is not consistent
- we agreed to display warning when change is detected but can&rsquo;t be applied. This is not implemented yet in majority in the modules.</p>

<h2>Manual Idempotence Check</h2>

<ul>
<li>error prone</li>
<li>time consuming</li>
<li>no consistency between modules</li>
</ul>


<h2>Generic Compare Function</h2>

<ul>
<li>quite effective</li>
<li>robust</li>
<li>difficult to handle exceptions</li>
</ul>


<h3>Comparison Types</h3>

<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>exact</td>
<td>This kind of comparison should work for most of the properties.</td>
</tr>
<tr>
<td>case insensitive</td>
<td>for instance resource id may need this type of comparison</td>
</tr>
<tr>
<td>location</td>
<td> location may be returned in different formats, for instance <strong>east us</strong> or <strong>East US</strong></td>
</tr>
<tr>
<td>ignore</td>
<td>for properties that are not returned by GET, for instance passwords, secrets, or any other fields that we can&rsquo;t perform comparison</td>
</tr>
</tbody>
</table>


<h3>Exceptions</h3>

<ul>
<li>sometimes (quite rarely) structure returned by GET is different from PUT</li>
<li>some properties are not returned by GET, so can&rsquo;t compare</li>
<li>sometimes comparison method needs to be adjusted to particular scenario</li>
</ul>


<h2>Proposed Approach: Global Compare Function + Metadata in module_arg_spec</h2>

<p>I have done appropriate tests and:
- it&rsquo;s possible to add custom metadata to <strong>module_arg_spec</strong> without disturbing Ansible sanity checks</p>

<p>Therefore we could have Azure specific metadata defined as follows, to provide auxilliary information for modules about:
- updatability of the field
- field relationship to structures obtained from <strong>Get</strong> and <strong>CreateOrUpdate</strong>
- idempotence comparison method</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="bp">self</span><span class="o">.</span><span class="n">module_arg_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class='line'>    <span class="c"># ...</span>
</span><span class='line'>    <span class="n">option_a</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span class='line'>        <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
</span><span class='line'>        <span class="c"># Azure Module Specific Metadata</span>
</span><span class='line'>        <span class="n">updatable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class='line'>        <span class="n">disposition</span><span class="o">=</span><span class="s">&#39;parameters/option_a&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">comparison</span><span class="o">=</span><span class="s">&#39;insensitive&#39;</span>
</span><span class='line'>    <span class="p">),</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<table>
<thead>
<tr>
<th>Name</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>updatable</td>
<td><strong>True</strong></td>
<td>Set to <strong>False</strong> if property cannot be updated. Warning will be automatically generated if change is detected.</td>
</tr>
<tr>
<td>disposition</td>
<td>-</td>
<td>Different name or path if property in different location after expanding options</td>
</tr>
<tr>
<td>comparison</td>
<td><strong>exact</strong></td>
<td>Comparison method, use one of: <strong>exact</strong>, <strong>insensitive</strong>, <strong>location</strong>, <strong>ignore</strong></td>
</tr>
</tbody>
</table>


<p>Module base will provide function:</p>

<p><strong>map_and_compare(old_properties)</strong></p>

<p><strong>old_properties</strong> is a dictionary returned by <strong>Get</strong> or empty dictionary <strong>{}</strong>.</p>

<p>Function will map new property values into existing dictionary or populate empty dictionary.</p>

<p>Function will return <strong>True</strong> if any change is detected.</p>

<p>Function will generate appropriate warnings if change of non-updatable fields is detected.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ansible Module Anatomy]]></title>
    <link href="http://zikalino.github.io/blog/2019/02/21/ansible-module-anatomy/"/>
    <updated>2019-02-21T12:27:21+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/02/21/ansible-module-anatomy</id>
    <content type="html"><![CDATA[<p>This post describes what and where needs to be added in order to create a new module.</p>

<h3>File Locations</h3>

<p>Let&rsquo;s say you want to create modules for a new Azure resource. You will need two modules - main module and facts module.
Following files should be created in Ansible directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~/lib/ansible/modules/cloud/azure/azure_rm_xxxxx.py
</span><span class='line'>~/lib/ansible/modules/cloud/azure/azure_rm_xxxxx_facts.py</span></code></pre></td></tr></table></div></figure>


<p>In addition to modules you need to create integration test.
In order to do that you will have to create following files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~/test/integration/targets/azure_rm_xxxx/meta/main.yml
</span><span class='line'>~/test/integration/targets/azure_rm_xxxx/tasks/main.yml
</span><span class='line'>~/test/integration/targets/azure_rm_xxxx/aliases</span></code></pre></td></tr></table></div></figure>


<p>Please note that integration tests can be shared (and in many cases should be shared) by multiple modules.</p>

<h1>Typical Module Dissected</h1>

<h2>Header</h2>

<p>Module header is always the same. Only parts that are changed are:
- copyright year
- original contributor name
- original contributor git handle</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Copyright (c) 2019 John Doe, (@johndoe)</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
</span><span class='line'><span class="n">__metaclass__</span> <span class="o">=</span> <span class="nb">type</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">ANSIBLE_METADATA</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;metadata_version&#39;</span><span class="p">:</span> <span class="s">&#39;1.1&#39;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;preview&#39;</span><span class="p">],</span>
</span><span class='line'>                    <span class="s">&#39;supported_by&#39;</span><span class="p">:</span> <span class="s">&#39;community&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Documentation</h2>

<p>The next section is the documentation</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">DOCUMENTATION</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
</span><span class='line'><span class="s">---</span>
</span><span class='line'><span class="s">module: azure_rm_devtestlabvirtualmachine</span>
</span><span class='line'><span class="s">version_added: &quot;2.8&quot;</span>
</span><span class='line'><span class="s">short_description: Manage Azure DevTest Lab Virtual Machine instance.</span>
</span><span class='line'><span class="s">description:</span>
</span><span class='line'><span class="s">    - Create, update and delete instance of Azure DevTest Lab Virtual Machine.</span>
</span><span class='line'>
</span><span class='line'><span class="s">options:</span>
</span><span class='line'><span class="s">    resource_group:</span>
</span><span class='line'><span class="s">        description:</span>
</span><span class='line'><span class="s">            - The name of the resource group.</span>
</span><span class='line'><span class="s">        required: True</span>
</span><span class='line'><span class="s">    lab_name:</span>
</span><span class='line'><span class="s">        description:</span>
</span><span class='line'><span class="s">            - The name of the lab.</span>
</span><span class='line'><span class="s">        required: True</span>
</span><span class='line'><span class="s">    name:</span>
</span><span class='line'><span class="s">        description:</span>
</span><span class='line'><span class="s">            - The name of the virtual machine.</span>
</span><span class='line'><span class="s">        required: True</span>
</span><span class='line'><span class="s">    notes:</span>
</span><span class='line'><span class="s">        description:</span>
</span><span class='line'><span class="s">            - The notes of the virtual machine.</span>
</span><span class='line'><span class="s">    state:</span>
</span><span class='line'><span class="s">      description:</span>
</span><span class='line'><span class="s">        - Assert the state of the Virtual Machine.</span>
</span><span class='line'><span class="s">        - Use &#39;present&#39; to create or update an Virtual Machine and &#39;absent&#39; to delete it.</span>
</span><span class='line'><span class="s">      default: present</span>
</span><span class='line'><span class="s">      choices:</span>
</span><span class='line'><span class="s">        - absent</span>
</span><span class='line'><span class="s">        - present</span>
</span><span class='line'>
</span><span class='line'><span class="s">extends_documentation_fragment:</span>
</span><span class='line'><span class="s">    - azure</span>
</span><span class='line'><span class="s">    - azure_tags</span>
</span><span class='line'>
</span><span class='line'><span class="s">author:</span>
</span><span class='line'><span class="s">    - &quot;Zim Kalinowski (@zikalino)&quot;</span>
</span><span class='line'><span class="s">&#39;&#39;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Examples</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">EXAMPLES</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
</span><span class='line'><span class="s">  - name: Create (or update) Virtual Machine</span>
</span><span class='line'><span class="s">    azure_rm_devtestlabvirtualmachine:</span>
</span><span class='line'><span class="s">      resource_group: myrg</span>
</span><span class='line'><span class="s">      lab_name: mylab</span>
</span><span class='line'><span class="s">      name: myvm</span>
</span><span class='line'><span class="s">      notes: Virtual machine notes....</span>
</span><span class='line'><span class="s">      os_type: linux</span>
</span><span class='line'><span class="s">      vm_size: Standard_A2_v2</span>
</span><span class='line'><span class="s">      user_name: vmadmin</span>
</span><span class='line'><span class="s">      password: ZSuppas$$21!</span>
</span><span class='line'><span class="s">      lab_subnet:</span>
</span><span class='line'><span class="s">        name: myvnSubnet</span>
</span><span class='line'><span class="s">        virtual_network_name: myvn</span>
</span><span class='line'><span class="s">      disallow_public_ip_address: no</span>
</span><span class='line'><span class="s">      image:</span>
</span><span class='line'><span class="s">        offer: UbuntuServer</span>
</span><span class='line'><span class="s">        publisher: Canonical</span>
</span><span class='line'><span class="s">        sku: 16.04-LTS</span>
</span><span class='line'><span class="s">        os_type: Linux</span>
</span><span class='line'><span class="s">        version: latest</span>
</span><span class='line'><span class="s">      artifacts:</span>
</span><span class='line'><span class="s">        - source_name: myartifact</span>
</span><span class='line'><span class="s">          source_path: &quot;/Artifacts/linux-install-mongodb&quot;</span>
</span><span class='line'><span class="s">      allow_claim: no</span>
</span><span class='line'><span class="s">      expiration_date: &quot;2019-02-22T01:49:12.117974Z&quot;</span>
</span><span class='line'><span class="s">&#39;&#39;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Return Value</h2>

<p>Return value should contain detailed specification of return value in YAML format.</p>

<p>Please note that the main module should:
- contain resource id
- contain information that is essential for subsequent use of the resource (for instance FQDN, IP address, etc.)
- shouldn&rsquo;t contain information that is supplied via input parameters</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">RETURN</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
</span><span class='line'><span class="s">id:</span>
</span><span class='line'><span class="s">    description:</span>
</span><span class='line'><span class="s">        - The identifier of the DTL Virtual Machine resource.</span>
</span><span class='line'><span class="s">    returned: always</span>
</span><span class='line'><span class="s">    type: str</span>
</span><span class='line'><span class="s">    sample: /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourcegroups/myrg/providers/microsoft.devtestlab/labs/mylab/virtualmachines/myvm</span>
</span><span class='line'><span class="s">compute_id:</span>
</span><span class='line'><span class="s">    description:</span>
</span><span class='line'><span class="s">        - The identifier of the underlying Compute Virtual Machine resource.</span>
</span><span class='line'><span class="s">    returned: always</span>
</span><span class='line'><span class="s">    type: str</span>
</span><span class='line'><span class="s">    sample: /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourcegroups/myrg/providers/microsoft.devtestlab/labs/mylab/virtualmachines/myvm</span>
</span><span class='line'><span class="s">fqdn:</span>
</span><span class='line'><span class="s">    description:</span>
</span><span class='line'><span class="s">        - Fully qualified domain name or IP Address of the virtual machine.</span>
</span><span class='line'><span class="s">    returned: always</span>
</span><span class='line'><span class="s">    type: str</span>
</span><span class='line'><span class="s">    sample: myvm.eastus.cloudapp.azure.com</span>
</span><span class='line'><span class="s">&#39;&#39;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Imports</h2>

<p>Usually very similar, may contain additional imports related to particular Azure resource, etc.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">ansible.module_utils.azure_rm_common</span> <span class="kn">import</span> <span class="n">AzureRMModuleBase</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">ansible.module_utils.common.dict_transformations</span> <span class="kn">import</span> <span class="n">_snake_to_camel</span>
</span><span class='line'>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="kn">from</span> <span class="nn">msrestazure.azure_exceptions</span> <span class="kn">import</span> <span class="n">CloudError</span>
</span><span class='line'>    <span class="kn">from</span> <span class="nn">msrest.polling</span> <span class="kn">import</span> <span class="n">LROPoller</span>
</span><span class='line'>    <span class="kn">from</span> <span class="nn">msrestazure.azure_operation</span> <span class="kn">import</span> <span class="n">AzureOperationPoller</span>
</span><span class='line'>    <span class="kn">from</span> <span class="nn">azure.mgmt.devtestlabs</span> <span class="kn">import</span> <span class="n">DevTestLabsClient</span>
</span><span class='line'>    <span class="kn">from</span> <span class="nn">msrest.serialization</span> <span class="kn">import</span> <span class="n">Model</span>
</span><span class='line'><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span class='line'>    <span class="c"># This is handled in azure_rm_common</span>
</span><span class='line'>    <span class="k">pass</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Class Definition and Init Function</h2>

<p>Action types definition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">Actions</span><span class="p">:</span>
</span><span class='line'>    <span class="n">NoAction</span><span class="p">,</span> <span class="n">Create</span><span class="p">,</span> <span class="n">Update</span><span class="p">,</span> <span class="n">Delete</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">AzureRMVirtualMachine</span><span class="p">(</span><span class="n">AzureRMModuleBase</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Configuration class for an Azure RM Virtual Machine resource&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Module Argument Specification</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">module_arg_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class='line'>        <span class="n">resource_group</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span class='line'>            <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">required</span><span class="o">=</span><span class="bp">True</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">lab_name</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span class='line'>            <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">required</span><span class="o">=</span><span class="bp">True</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">name</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span class='line'>            <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">required</span><span class="o">=</span><span class="bp">True</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">notes</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span class='line'>            <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Conditional Required Options</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="n">required_if</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">,</span> <span class="s">&#39;present&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>         <span class="s">&#39;image&#39;</span><span class="p">,</span> <span class="s">&#39;lab_subnet&#39;</span><span class="p">,</span> <span class="s">&#39;vm_size&#39;</span><span class="p">,</span> <span class="s">&#39;os_type&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Argument Properties</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">lab_name</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Module State</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">changed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">mgmt_client</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">to_do</span> <span class="o">=</span> <span class="n">Actions</span><span class="o">.</span><span class="n">NoAction</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Base Class Initialization</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="nb">super</span><span class="p">(</span><span class="n">AzureRMVirtualMachine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">derived_arg_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_arg_spec</span><span class="p">,</span>
</span><span class='line'>                                                <span class="n">supports_check_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
</span><span class='line'>                                                <span class="n">supports_tags</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
</span><span class='line'>                                                <span class="n">required_if</span><span class="o">=</span><span class="n">required_if</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Main Module Execution Method</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">exec_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Main module execution method&quot;&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Mapping parameters to class properties:</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_arg_spec</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">]:</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span class='line'>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Parameter transformations</h3>

<p>Notes:
- we have several approaches right now
- in general here input parameters structure should be converted to match SDK call parameters</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;gallery_image_reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;image&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;artifacts&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">artifact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;artifacts&#39;</span><span class="p">):</span>
</span><span class='line'>            <span class="n">source_name</span> <span class="o">=</span> <span class="n">artifact</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;source_name&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">source_path</span> <span class="o">=</span> <span class="n">artifact</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;source_path&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">template</span> <span class="o">=</span> <span class="s">&quot;/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DevTestLab/labs/{2}/artifactsources/{3}{4}&quot;</span>
</span><span class='line'>            <span class="n">artifact</span><span class="p">[</span><span class="s">&#39;artifact_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_name</span><span class="p">,</span> <span class="n">source_name</span><span class="p">,</span> <span class="n">source_path</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;vm_size&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;os_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_snake_to_camel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;os_type&#39;</span><span class="p">],</span> <span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;storage_type&#39;</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;storage_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_snake_to_camel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;storage_type&#39;</span><span class="p">],</span> <span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lab_subnet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;lab_subnet&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lab_subnet</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span class='line'>        <span class="n">vn_and_subnet</span> <span class="o">=</span> <span class="n">lab_subnet</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/subnets/&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vn_and_subnet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;lab_virtual_network_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vn_and_subnet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;lab_subnet_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vn_and_subnet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Invalid &#39;lab_subnet&#39; resource id format&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">template</span> <span class="o">=</span> <span class="s">&quot;/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DevTestLab/labs/{2}/virtualnetworks/{3}&quot;</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;lab_virtual_network_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span><span class="p">,</span>
</span><span class='line'>                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="p">,</span>
</span><span class='line'>                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">lab_name</span><span class="p">,</span>
</span><span class='line'>                                                                             <span class="n">lab_subnet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;virtual_network_name&#39;</span><span class="p">))</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;lab_subnet_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lab_subnet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Create Mgmt Client Instance</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">mgmt_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mgmt_svc_client</span><span class="p">(</span><span class="n">DevTestLabsClient</span><span class="p">,</span>
</span><span class='line'>                                                <span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cloud_environment</span><span class="o">.</span><span class="n">endpoints</span><span class="o">.</span><span class="n">resource_manager</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Getting old response and idempotency check</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="n">old_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virtualmachine</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">old_response</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Virtual Machine instance doesn&#39;t exist&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s">&#39;absent&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Old instance didn&#39;t exist&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">to_do</span> <span class="o">=</span> <span class="n">Actions</span><span class="o">.</span><span class="n">Create</span>
</span><span class='line'>        <span class="c"># get location from the lab as it has to be the same and has to be specified (why??)</span>
</span><span class='line'>        <span class="n">lab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_devtestlab</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lab</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Virtual Machine instance already exists&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s">&#39;absent&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">to_do</span> <span class="o">=</span> <span class="n">Actions</span><span class="o">.</span><span class="n">Delete</span>
</span><span class='line'>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s">&#39;present&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;size&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Property &#39;size&#39; cannot be changed&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;storage_type&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
</span><span class='line'>               <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;storage_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;storage_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;storage_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;storage_type&#39;</span><span class="p">]</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Property &#39;storage_type&#39; cannot be changed&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="n">old_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;gallery_image_reference&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;gallery_image_reference&#39;</span><span class="p">,</span> <span class="p">{}):</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;gallery_image_reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;gallery_image_reference&#39;</span><span class="p">]</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Property &#39;image&#39; cannot be changed&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="c"># currently artifacts can be only specified when vm is created</span>
</span><span class='line'>            <span class="c"># and in addition we don&#39;t have detailed information, just a number of &quot;total artifacts&quot;</span>
</span><span class='line'>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;artifacts&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">!=</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;artifact_deployment_status&#39;</span><span class="p">][</span><span class="s">&#39;total_artifacts&#39;</span><span class="p">]:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Property &#39;artifacts&#39; cannot be changed&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;disallow_public_ip_address&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;disallow_public_ip_address&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;disallow_public_ip_address&#39;</span><span class="p">):</span>
</span><span class='line'>                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Property &#39;disallow_public_ip_address&#39; cannot be changed&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;disallow_public_ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;disallow_public_ip_address&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;allow_claim&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;allow_claim&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;allow_claim&#39;</span><span class="p">):</span>
</span><span class='line'>                    <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Property &#39;allow_claim&#39; cannot be changed&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;allow_claim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;allow_claim&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;notes&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;notes&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;notes&#39;</span><span class="p">):</span>
</span><span class='line'>                    <span class="bp">self</span><span class="o">.</span><span class="n">to_do</span> <span class="o">=</span> <span class="n">Actions</span><span class="o">.</span><span class="n">Update</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">[</span><span class="s">&#39;notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;notes&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Performing Desired Action</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_do</span> <span class="o">==</span> <span class="n">Actions</span><span class="o">.</span><span class="n">Create</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_do</span> <span class="o">==</span> <span class="n">Actions</span><span class="o">.</span><span class="n">Update</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Need to Create / Update the Virtual Machine instance&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;changed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mode</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_update_virtualmachine</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Creation / Update done&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_do</span> <span class="o">==</span> <span class="n">Actions</span><span class="o">.</span><span class="n">Delete</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Virtual Machine instance deleted&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;changed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mode</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">delete_virtualmachine</span><span class="p">()</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Virtual Machine instance unchanged&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;changed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="n">old_response</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Formatting Response</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s">&#39;present&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span class='line'>            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
</span><span class='line'>            <span class="s">&#39;compute_id&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;compute_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
</span><span class='line'>            <span class="s">&#39;fqdn&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;fqdn&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create / Update Function</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">create_update_virtualmachine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;</span>
</span><span class='line'><span class="sd">    Creates or updates Virtual Machine with the specified configuration.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    :return: deserialized Virtual Machine instance state dictionary</span>
</span><span class='line'><span class="sd">    &#39;&#39;&#39;</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Creating / Updating the Virtual Machine instance {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgmt_client</span><span class="o">.</span><span class="n">virtual_machines</span><span class="o">.</span><span class="n">create_or_update</span><span class="p">(</span><span class="n">resource_group_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="p">,</span>
</span><span class='line'>                                                                      <span class="n">lab_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lab_name</span><span class="p">,</span>
</span><span class='line'>                                                                      <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span class='line'>                                                                      <span class="n">lab_virtual_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lab_virtual_machine</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">LROPoller</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">AzureOperationPoller</span><span class="p">):</span>
</span><span class='line'>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_poller_result</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">except</span> <span class="n">CloudError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Error attempting to create the Virtual Machine instance.&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Error creating the Virtual Machine instance: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Delete Function</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">delete_virtualmachine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;</span>
</span><span class='line'><span class="sd">    Deletes specified Virtual Machine instance in the specified subscription and resource group.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    :return: True</span>
</span><span class='line'><span class="sd">    &#39;&#39;&#39;</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Deleting the Virtual Machine instance {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgmt_client</span><span class="o">.</span><span class="n">virtual_machines</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">resource_group_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="p">,</span>
</span><span class='line'>                                                            <span class="n">lab_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lab_name</span><span class="p">,</span>
</span><span class='line'>                                                            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span> <span class="n">CloudError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Error attempting to delete the Virtual Machine instance.&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Error deleting the Virtual Machine instance: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">LROPoller</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">AzureOperationPoller</span><span class="p">):</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_poller_result</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Get Function</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">get_virtualmachine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;</span>
</span><span class='line'><span class="sd">    Gets the properties of the specified Virtual Machine.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    :return: deserialized Virtual Machine instance state dictionary</span>
</span><span class='line'><span class="sd">    &#39;&#39;&#39;</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Checking if the Virtual Machine instance {0} is present&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgmt_client</span><span class="o">.</span><span class="n">virtual_machines</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_group_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="p">,</span>
</span><span class='line'>                                                         <span class="n">lab_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lab_name</span><span class="p">,</span>
</span><span class='line'>                                                         <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>        <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Response : {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Virtual Machine instance : {0} found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span class='line'>    <span class="k">except</span> <span class="n">CloudError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Did not find the Virtual Machine instance.&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">found</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="bp">False</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Module Entry Point</h2>

<p>Always the same and looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Main execution&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">AzureRMVirtualMachine</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">main</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Installing Ansible Using Cloud-init]]></title>
    <link href="http://zikalino.github.io/blog/2019/02/01/installing-ansible-using-cloud-init/"/>
    <updated>2019-02-01T11:25:16+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/02/01/installing-ansible-using-cloud-init</id>
    <content type="html"><![CDATA[<p>Recently was playing with <strong>cloud-init</strong> a bit, and it seems like a great and consistent way of setting up Ansible VMs.
Here&rsquo;s an example of creating a virtual machine via Azure portal and installing Ansible at once.</p>

<p>What you need to do is to go to <strong>Guest Config</strong> tag and add appropriate <strong>cloud-config</strong> playbook:</p>

<p><img src="http://zikalino.github.io/images/cloud-init-ansible.png" alt="Guest Config" /></p>

<p>In this example I am using following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1">#cloud-config</span>
</span><span class='line'><span class="l-Scalar-Plain">packages</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">python-pip</span>
</span><span class='line'><span class="l-Scalar-Plain">runcmd</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo pip install ansible</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo ansible-galaxy install azure.azure_preview_modules</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo pip install -r ~/.ansible/roles/azure.azure_preview_modules/files/requirements-azure.txt</span>
</span></code></pre></td></tr></table></div></figure>


<p>It can be even shorted if you don&rsquo;t need Azure preview modules:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1">#cloud-config</span>
</span><span class='line'><span class="l-Scalar-Plain">packages</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">python-pip</span>
</span><span class='line'><span class="l-Scalar-Plain">runcmd</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo pip install ansible[azure]</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Waiting for Resources in Ansible]]></title>
    <link href="http://zikalino.github.io/blog/2019/01/25/waiting-for-resources-in-ansible/"/>
    <updated>2019-01-25T07:08:54+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/01/25/waiting-for-resources-in-ansible</id>
    <content type="html"><![CDATA[<p>Some resources may be not in a desired state after running a playbook. Especially when using Azure REST API, resource may be in <strong>Creating</strong> or <strong>Provisioning</strong> state. Sometimes it&rsquo;s necessary to wait unll provisioning state becomes <strong>Succeeded</strong>.</p>

<p>The best way to do this is to use <strong>facts</strong> module to periodically query the resource and exit the loop when desired state is achieved. Here&rsquo;s how to do it.</p>

<p>After the task that creates your virtual machine (or later), put following tasks. Actually only <strong>Wait for Virtual Machine to be ready</strong> is essential here. All the other tasks are just for demo purposes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Get VM facts</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_resource_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="s">&#39;2018-10-01&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Compute</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">virtualMachines</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_name</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output.response[0].properties.provisioningState</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for Virtual Machine to be ready</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_resource_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="s">&#39;2018-10-01&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Compute</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">virtualMachines</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_name</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
</span><span class='line'>  <span class="l-Scalar-Plain">until</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output.response[0].properties.provisioningState == &#39;Succeeded&#39;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">60</span>
</span><span class='line'>  <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output.response[0].properties.provisioningState</span>
</span></code></pre></td></tr></table></div></figure>


<p>You should see following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">TASK [Create a vm with password authentication.] *******************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">changed</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [Get VM facts] ************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [debug] ******************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&quot;output.response[0].properties.provisioningState&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Creating&quot;</span>
</span><span class='line'><span class="err">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [Wait for Virtual Machine to be ready] *****************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">FAILED - RETRYING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for Virtual Machine to be ready (5 retries left).</span>
</span><span class='line'><span class="l-Scalar-Plain">FAILED - RETRYING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for Virtual Machine to be ready (4 retries left).</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [debug] ******************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&quot;output.response[0].properties.provisioningState&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;Succeeded&quot;</span>
</span><span class='line'><span class="err">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">PLAY RECAP ********************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">localhost</span>                  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ok=18   changed=1    unreachable=0    failed=0    skipped=0</span>
</span></code></pre></td></tr></table></div></figure>


<p>References:</p>

<p>Ansible documentation on do-until loops:
<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html#do-until-loops">https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html#do-until-loops</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Installing HTTPD on VMSS Using VMSS Extension]]></title>
    <link href="http://zikalino.github.io/blog/2019/01/24/installing-httpd-on-vmss-using-vmss-extension/"/>
    <updated>2019-01-24T09:33:49+08:00</updated>
    <id>http://zikalino.github.io/blog/2019/01/24/installing-httpd-on-vmss-using-vmss-extension</id>
    <content type="html"><![CDATA[<p>There are two (or three) proper ways of updating Virtual Machine Scale Set instances:</p>

<ul>
<li>use custom images and update instances whenever something changes</li>
<li>use VMSS Extension to install additional software on all the VM instances</li>
<li>combine both</li>
</ul>


<p>Possibly there&rsquo;s a fourth way, but I haven&rsquo;t investigated that yet. I am thinking of updating VMSS data disks on the fly, but I haven&rsquo;t tried that yet. Let&rsquo;s focus on using VMSS Extension. In this article I will show how to use new <strong>azure_rm_virtualmachinescalesetextension</strong> module. It&rsquo;s already available in <strong>azure_preview_modules</strong> and will be released in <strong>Ansible 2.8</strong>.</p>

<h2>Prerequisites</h2>

<p>Before trying the playbooks, clone following repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone https://github.com/Azure-Samples/ansible-playbooks.git
</span><span class='line'><span class="nb">cd </span>ansible-playbooks/vmss_extension
</span></code></pre></td></tr></table></div></figure>


<h2>Step 1: Create VMSS using Ubuntu 16.04 Image</h2>

<p>In this step we will just create Azure Virtual Machine Scaleset based using standard Ubuntu 16.04 image and all prerequisites.</p>

<p>Run following playbook:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ansible-playbook 01-create-vmss.yml --extra-vars <span class="s2">&quot;resource_group=myrg&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After this playbook is executed you will see an IP addres. Copy it to the browser. The page should fail to open as initial Ubuntu 16.04 image doesn&rsquo;t have web server installed.</p>

<p>You can also go to Azure Portal and check the status of VMSS instances:</p>

<p><img src="http://zikalino.github.io/images/vmss-extension-01.png" alt="VMSS Instances 1" /></p>

<h2>Step 2: Install VMSS extension</h2>

<p>In second step we will install a <strong>Custom Script</strong> VMSS extension that will install <strong>httpd</strong>.</p>

<p>Run following playbook:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ansible-playbook 02-setup-httpd.yml --extra-vars <span class="s2">&quot;resource_group=myrg&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this step we use <strong>azure_rm_virtualmachinescalesetextension</strong> module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create VM Extension - HTTPD</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_virtualmachinescalesetextension</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">vmss_name</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">testVMExtension</span>
</span><span class='line'>    <span class="l-Scalar-Plain">publisher</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Microsoft.Azure.Extensions</span>
</span><span class='line'>    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">CustomScript</span>
</span><span class='line'>    <span class="l-Scalar-Plain">type_handler_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2.0</span>
</span><span class='line'>    <span class="l-Scalar-Plain">auto_upgrade_minor_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="l-Scalar-Plain">settings</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span><span class="s">&quot;commandToExecute&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;sudo</span><span class="nv"> </span><span class="s">apt-get</span><span class="nv"> </span><span class="s">-y</span><span class="nv"> </span><span class="s">install</span><span class="nv"> </span><span class="s">apache2&quot;</span><span class="p-Indicator">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note that creating extension didn&rsquo;t update existing instances. You can check how it looks in the portal again - as you see all the instances are not up to date:</p>

<p><img src="http://zikalino.github.io/images/vmss-extension-02.png" alt="VMSS Instances 2" /></p>

<h2>Step 3: Update all the instances</h2>

<p>In this step we will actually upgrade all VM instances. Run following script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">ansible-playbook 03-update-instances.yml --extra-vars &quot;resource_group=myrg&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>First <strong>azure_rm_virtualmachinescalesetinstance_facts</strong> module is used to get list of instances:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">List all of the instances</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_virtualmachinescalesetinstance_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">vmss_name</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">instances</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then <strong>azure_rm_virtualmachinescalesetinstance</strong> module to set <strong>latest_version</strong> to <strong>yes</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">manually upgrade all the instances</span>
</span><span class='line'>  <span class="l-Scalar-Plain">azure_rm_virtualmachinescalesetinstance</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resource_group</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">vmss_name</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_id</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">latest_model</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>  <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, you can see in the portal how instances are being updated one by one:</p>

<p><img src="http://zikalino.github.io/images/vmss-extension-03.png" alt="VMSS Instances 3" /></p>

<p>When update is completed reload the page, and you should see that this time default Apache index page is displayed:</p>

<p><img src="http://zikalino.github.io/images/vmss-extension-04.png" alt="VMSS Instances 4" /></p>
]]></content>
  </entry>
  
</feed>
